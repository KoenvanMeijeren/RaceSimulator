<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\Development\C#\RaceSimulator\RaceSimulator\CVisualization.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Controller;
using Model;

namespace RaceSimulator
{
    public static class CVisualization
    {

        private const Directions StartDirection = Directions.East;
        private static Directions _direction = CVisualization.StartDirection;

        private const int
            TrackPositionUndefined = -1,
            SymbolSpaces = 4,

            /*
             * The first property determines the max length of the initials and trims the initials
             * to the selected length. The second property determines the index of the initials
             * inside a string of the graphics strings.
             *
             * If we have the string: &quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot; for example, the initials
             * will be placed on the selected position. The third and fourth property determines
             * which string of the symbols we have to take. 
             *
             * If the value of the first property is 0, and of the second 1 and of the third 2,
             * the output will be this: &quot;----&quot;, &quot;AB| &quot;, &quot;CD| &quot;, &quot;----&quot; or &quot;----&quot;, &quot;A | &quot;, &quot;BC| &quot;, &quot;----&quot;
             * or &quot;----&quot;, &quot;AB| &quot;, &quot;  | &quot;, &quot;----&quot;.
             */
            MaxInitialsLength = 1,
            InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex = 1,
            InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex = 2;

        private static readonly int
            CursorStartEastPosition = Console.WindowWidth / 2, 
            CursorStartNorthPosition = Console.WindowHeight / 2;

        private static int
            _trackEastPosition = TrackPositionUndefined,
            _trackNorthPosition = TrackPositionUndefined,
            _cursorEastPosition = CursorStartEastPosition,
            _cursorNorthPosition = CursorStartNorthPosition;

        #region graphics

        private static readonly string[]
            FinishHorizontal = {&quot;----&quot;, &quot;  # &quot;, &quot;  # &quot;, &quot;----&quot;},
            FinishVertical = {&quot;|  |&quot;, &quot;|##|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StartGridHorizontal = {&quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot;},
            StartGridVertical = {&quot;|  |&quot;, &quot;|--|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StraightHorizontal = {&quot;----&quot;, &quot;    &quot;, &quot;    &quot;, &quot;----&quot;},
            StraightVertical = {&quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            NorthCornerToRight = {&quot;|  /&quot;, &quot;|   &quot;, &quot;/   &quot;, &quot; /--&quot;},
            NorthCornerToLeft = {&quot;\\  |&quot;, &quot;   |&quot;, &quot;   \\&quot;, &quot;--\\ &quot;},

            EastCornerToRight = {&quot;--\\ &quot;, &quot;   \\&quot;, &quot;   |&quot;, &quot;\\  |&quot;},
            EastCornerToLeft = {&quot;/  |&quot;, &quot;   |&quot;, &quot;   /&quot;, &quot;--/ &quot;},

            SouthCornerToRight = CVisualization.EastCornerToLeft,
            SouthCornerToLeft = {&quot;|  \\&quot;, &quot;|   &quot;, &quot;\\   &quot;, &quot; \\--&quot;},

            WestCornerToRight = CVisualization.SouthCornerToLeft,
            WestCornerToLeft = {&quot; /--&quot;, &quot;/   &quot;, &quot;|   &quot;, &quot;|  /&quot;};
        #endregion

        public static void Initialize()
        {
            Race.DriversChanged += CVisualization.OnDriversChanged;
        }

        private static void OnDriversChanged(object sender, DriversChangedEventArgs eventArgs)
        {
            CVisualization.DrawTrack(eventArgs.Race);
        }

        public static void DrawTrack(Race race)
        {
            Track track = race.Track;
            int 
                northPosition = CVisualization.GetNorthPosition(track), 
                eastPosition = CVisualization.GetEastPosition(track);
            
            Console.BackgroundColor = ConsoleColor.Blue;
            Console.ForegroundColor = ConsoleColor.White;
            Console.Clear();

            Console.SetCursorPosition(CenteredTextCursorStartPosition(track.Name),  northPosition &lt; 5 ? 1 :  northPosition - 4);
            Console.WriteLine(track.Name);
            
            CVisualization._direction = CVisualization.StartDirection;
            CVisualization._cursorEastPosition = eastPosition &lt; 20 ? CVisualization.CursorStartEastPosition : eastPosition;
            CVisualization._cursorNorthPosition = northPosition &lt; 10 ? northPosition + 10 : northPosition;

            foreach (Section trackSection in track.Sections)
            {
                CVisualization.DrawTrackSection(trackSection, race.GetSectionData(trackSection));
            }
        }
        
        private static int GetEastPosition(Track track)
        {
            if (CVisualization._trackEastPosition != CVisualization.TrackPositionUndefined)
            {
                return CVisualization._trackEastPosition;
            }

            int
                westwardSections = track.GetWestwardSectionsCount() * SymbolSpaces,
                eastwardSections = track.GetWestwardSectionsCount() * SymbolSpaces;
            
            if (eastwardSections == Track.SectionCountUndefined || westwardSections == Track.SectionCountUndefined)
            {
                return CVisualization.CursorStartEastPosition;
            }
            
            CVisualization._trackEastPosition = eastwardSections + (westwardSections - eastwardSections);
            
            return CVisualization._trackEastPosition;
        }

        private static int GetNorthPosition(Track track)
        {
            if (CVisualization._trackNorthPosition != CVisualization.TrackPositionUndefined)
            {
                return CVisualization._trackNorthPosition;
            }

            int
                southwardSections = track.GetSouthwardSectionsCount() * SymbolSpaces,
                northwardSections = track.GetNorthwardSectionsCount() * SymbolSpaces;
            
            if (northwardSections == Track.SectionCountUndefined || southwardSections == Track.SectionCountUndefined)
            {
                return CVisualization.CursorStartNorthPosition;
            }
            
            CVisualization._trackNorthPosition = southwardSections + (northwardSections - southwardSections);

            return CVisualization._trackNorthPosition;
        }

        private static void DrawTrackSection(Section section, SectionData sectionData)
        {
            switch (section.SectionType)
            {
                case SectionTypes.StartGrid:
                    DrawStartGrid(sectionData);
                    break;
                case SectionTypes.Straight:
                    DrawStraight(sectionData);
                    break;
                case SectionTypes.LeftCorner:
                    DrawLeftCorner(sectionData);
                    break;
                case SectionTypes.RightCorner:
                    DrawRightCorner(sectionData);
                    break;
                case SectionTypes.Finish:
                    DrawFinish(sectionData);
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;Unknown section type given!&quot;);
            }
        }

        private static bool DirectionIsVertical()
        {
            return CVisualization._direction is Directions.South or Directions.North;
        }

        private static void DrawLeftCorner(SectionData sectionData = null)
        {
            switch (CVisualization._direction)
            {
                case Directions.East:
                    DrawDownwards(CVisualization.EastCornerToLeft, sectionData);
                    CVisualization._direction = Directions.North;
                    break;
                case Directions.South:
                    DrawDownwards(CVisualization.SouthCornerToLeft, sectionData);
                    CVisualization._direction = Directions.East;
                    break;
                case Directions.West:
                    DrawDownwards(CVisualization.WestCornerToLeft, sectionData);
                    CVisualization._direction = Directions.South;
                    break;
                case Directions.North:
                    DrawUpwards(CVisualization.NorthCornerToLeft, sectionData);
                    CVisualization._direction = Directions.West;
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;_direction&quot;);
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawRightCorner(SectionData sectionData = null)
        {
            switch (CVisualization._direction)
            {
                case Directions.East:
                    DrawDownwards(CVisualization.EastCornerToRight, sectionData);
                    CVisualization._direction = Directions.South;
                    break;
                case Directions.South:
                    DrawDownwards(CVisualization.SouthCornerToRight, sectionData);
                    CVisualization._direction = Directions.West;
                    break;
                case Directions.West:
                    DrawDownwards(CVisualization.WestCornerToRight, sectionData);
                    CVisualization._direction = Directions.North;
                    break;
                case Directions.North:
                    DrawUpwards(CVisualization.NorthCornerToRight, sectionData);
                    CVisualization._direction = Directions.East;
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;_direction&quot;);
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawStraight(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StraightVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StraightHorizontal, sectionData);
        }

        private static void DrawStartGrid(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StartGridVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StartGridHorizontal, sectionData);
        }

        private static void DrawFinish(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.FinishVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.FinishHorizontal, sectionData);
        }

        private static void Draw(string[] symbols, SectionData sectionData = null)
        {
            if (CVisualization._direction is Directions.East or Directions.West or Directions.South)
            {
                DrawDownwards(symbols, sectionData);
            }
            else
            {
                DrawUpwards(symbols, sectionData);
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
            }
        }

        private static void DrawDownwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorDownwards();
            }
        }

        private static void DrawUpwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorUpwards();
            }
        }

        private static string[] SectionDataToSymbols(string[] symbols, SectionData sectionData = null)
        {
            if (sectionData == null || (sectionData.Left == null &amp;&amp; sectionData.Right == null))
            {
                return symbols;
            }

            if (CVisualization.SectionIsCorner(sectionData.Section.SectionType))
            {
                return CVisualization.PlaceParticipantsOnCorner(symbols, sectionData);
            }
            
            if (sectionData.Left != null &amp;&amp; sectionData.Right != null)
            {
                return CVisualization.PlaceParticipantsOnSection(
                    symbols.ToArray(), 
                    sectionData.Left, sectionData.DistanceLeft, 
                    sectionData.Right, sectionData.DistanceRight
                );
            }

            return CVisualization.PlaceParticipantOnSection(
                symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight,
                sectionData.Left != null
            );
        }

        private static string[] PlaceParticipantsOnCorner(string[] symbols, SectionData sectionData)
        {
            if (sectionData.Left != null &amp;&amp; sectionData.Right != null)
            {
                if (sectionData.Section.SectionType == SectionTypes.RightCorner)
                {
                    return CVisualization.PlaceParticipantsOnRightCorner(
                        symbols.ToArray(), 
                        sectionData.Left, sectionData.DistanceLeft, 
                        sectionData.Right, sectionData.DistanceRight
                    );
                }
                
                return CVisualization.PlaceParticipantsOnLeftCorner(
                    symbols.ToArray(), 
                    sectionData.Left, sectionData.DistanceLeft, 
                    sectionData.Right, sectionData.DistanceRight
                );
            }

            if (sectionData.Section.SectionType == SectionTypes.RightCorner)
            {
                return CVisualization.PlaceParticipantOnRightCorner(
                    symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                    sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight
                );
            }
            
            return CVisualization.PlaceParticipantOnLeftCorner(
                symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight
            );
        }

        private static string[] PlaceParticipantsOnLeftCorner(string[] symbols,IParticipant participantLeft, int distanceLeft, IParticipant participantRight, int distanceRight)
        {
            int
                indexOne = CVisualization.ConvertIndexForLeftCorner(distanceLeft, CVisualization._direction == Directions.East),
                indexTwo = CVisualization.ConvertIndexForLeftCorner(distanceRight, CVisualization._direction != Directions.East),
                distanceOne = CVisualization.ConvertDistanceForLeftCorner(distanceLeft, CVisualization._direction == Directions.East),
                distanceTwo = CVisualization.ConvertDistanceForLeftCorner(distanceRight, CVisualization._direction != Directions.East);

            string
                initialsOne = participantLeft.GetInitials(CVisualization.MaxInitialsLength),
                initialsTwo = participantRight.GetInitials(CVisualization.MaxInitialsLength);

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexTwo], initialsTwo, distanceTwo);
            
            return symbols;
        }

        private static string[] PlaceParticipantsOnRightCorner(string[] symbols,IParticipant participantLeft, int distanceLeft, IParticipant participantRight, int distanceRight)
        {
            int
                indexOne = CVisualization.ConvertIndexForRightCorner(distanceLeft, CVisualization._direction == Directions.West),
                indexTwo = CVisualization.ConvertIndexForRightCorner(distanceRight, CVisualization._direction != Directions.West),
                distanceOne = CVisualization.ConvertDistanceForRightCorner(distanceLeft, CVisualization._direction == Directions.West),
                distanceTwo = CVisualization.ConvertDistanceForRightCorner(distanceRight, CVisualization._direction != Directions.West);

            string
                initialsOne = participantLeft.GetInitials(CVisualization.MaxInitialsLength),
                initialsTwo = participantRight.GetInitials(CVisualization.MaxInitialsLength);

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexTwo], initialsTwo, distanceTwo);
            
            return symbols;
        }

        private static string[] PlaceParticipantOnLeftCorner(string[] symbols, IParticipant participant, int distance)
        {
            int index = CVisualization.ConvertIndexForLeftCorner(distance, CVisualization._direction == Directions.East),
                distanceOne = CVisualization.ConvertDistanceForLeftCorner(distance, CVisualization._direction == Directions.East);

            symbols[index] = CVisualization.MergeInitialsIntoSymbolByIndex(
                symbols[index], participant.GetInitials(CVisualization.MaxInitialsLength), distanceOne
            );

            return symbols;
        }

        private static string[] PlaceParticipantOnRightCorner(string[] symbols, IParticipant participant, int distance)
        {
            int index = CVisualization.ConvertIndexForRightCorner(distance, CVisualization._direction == Directions.West),
                distanceOne = CVisualization.ConvertDistanceForRightCorner(distance, CVisualization._direction == Directions.West);

            symbols[index] = CVisualization.MergeInitialsIntoSymbolByIndex(
                symbols[index], participant.GetInitials(CVisualization.MaxInitialsLength), distanceOne
            );

            return symbols;
        }
        
        private static string[] PlaceParticipantsOnSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            if (CVisualization.DirectionIsVertical())
            {
                return CVisualization.PlaceParticipantsOnVerticalSection(symbols, participantOne, distanceOne, participantTwo, distanceTwo);
            }
            
            return CVisualization.PlaceParticipantsOnHorizontalSection(symbols, participantOne, distanceOne, participantTwo, distanceTwo);
        }
        
        private static string[] PlaceParticipantOnSection(string[] symbols, IParticipant participant, int distance, bool left)
        {
            if (CVisualization.DirectionIsVertical())
            {
                return CVisualization.PlaceParticipantOnVerticalSection(symbols, participant, distance, left);
            }
            
            return CVisualization.PlaceParticipantOnHorizontalSection(symbols, participant, distance);
        }

        private static string[] PlaceParticipantsOnVerticalSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            int indexOne = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distanceOne);
            int indexTwo = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distanceTwo);
            if (indexOne &gt; 3)
            {
                indexOne = 3;
            }

            if (indexTwo &gt; 3)
            {
                indexTwo = 3;
            }
            
            string
                initialsStartOne = participantOne.GetInitials(CVisualization.MaxInitialsLength),
                initialsStartTwo = participantTwo.GetInitials(CVisualization.MaxInitialsLength),
                initialsOne = initialsStartOne,
                initialsTwo = initialsStartTwo;
            
            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexOne], initialsOne, 2);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexTwo], initialsTwo, 1);
            
            return symbols;
        }

        private static string[] PlaceParticipantsOnHorizontalSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            int indexOne = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex,
                indexTwo = CVisualization.InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex;
            string
                initialsStartOne = participantOne.GetInitials(CVisualization.MaxInitialsLength),
                initialsStartTwo = participantTwo.GetInitials(CVisualization.MaxInitialsLength),
                initialsOne = initialsStartOne,
                initialsTwo = initialsStartTwo;

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbol(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbol(symbols[indexTwo], initialsTwo, distanceTwo);

            return symbols;
        }
        
        private static string[] PlaceParticipantOnVerticalSection(string[] symbols, IParticipant participant, int distance, bool left)
        {
            int index = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            if (index &gt; 3)
            {
                index = 3;
            }

            string initials = participant.GetInitials(CVisualization.MaxInitialsLength);
            
            symbols[index] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[index], initials, left ? 2 : 1);
            
            return symbols;
        }

        private static string[] PlaceParticipantOnHorizontalSection(string[] symbols, IParticipant participant, int distance)
        {
            int index = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex;

            symbols[index] = CVisualization.MergeInitialsIntoSymbol(
                symbols[index], participant.GetInitials(CVisualization.MaxInitialsLength), distance
            );

            return symbols;
        }

        private static void MoveCursorUpwards()
        {
            CVisualization._cursorNorthPosition--;
        }

        private static void MoveCursorDownwards()
        {
            CVisualization._cursorNorthPosition++;
        }

        private static void WriteLine(string symbol)
        {
            Console.SetCursorPosition(CVisualization._cursorEastPosition, CVisualization._cursorNorthPosition);
            Console.WriteLine(symbol);
        }

        private static string MergeInitialsIntoSymbol(string symbol, string initials, int distance)
        { 
            int initialsStartIndex = CVisualization.ConvertDistanceToSymbolIndex(distance);

            return CVisualization.MergeInitialsIntoSymbolByIndex(symbol, initials, initialsStartIndex);
        }

        private static string MergeInitialsIntoSymbolByIndex(string symbol, string initials, int index)
        {
            int maxInitialsLength = initials.Length &lt; CVisualization.MaxInitialsLength ? initials.Length : CVisualization.MaxInitialsLength;
            int startIndex = CVisualization.FlipSymbolIndexIfNecessary(index);

            string trimmedInitials = initials.ToString();
            if (initials.Length &gt; CVisualization.MaxInitialsLength)
            {
                trimmedInitials = trimmedInitials.Remove(CVisualization.MaxInitialsLength);
            }

            if ((trimmedInitials.Length + startIndex) &gt; symbol.Length)
            {
                return symbol;
            }

            return symbol.Remove(startIndex, maxInitialsLength).Insert(startIndex, trimmedInitials);
        }

        private static int ConvertDistanceToSymbolIndex(int distance)
        {
            return Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
        }

        private static int FlipSymbolIndexIfNecessary(int distance)
        {
            if (CVisualization._direction == Directions.West)
            {
                distance = Race.ConvertRange(0, CVisualization.SymbolSpaces, CVisualization.SymbolSpaces, 0, distance);
            }

            return distance;
        }
        
        private static int CenteredTextCursorStartPosition(string text)
        {
            return (Console.WindowWidth / 2) - (text.Length / 2);
        }

        private static bool SectionIsCorner(SectionTypes sectionType)
        {
            return sectionType is SectionTypes.LeftCorner or SectionTypes.RightCorner;
        }
        
        private static int ConvertIndexForRightCorner(int distance, bool right)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            return newDistance switch
            {
                0 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; right ? 2 : 1,
                    Directions.South =&gt; 0,
                    Directions.North =&gt; 0,
                    Directions.West =&gt; right ? 1 : 2,
                    _ =&gt; 2
                },
                1 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; right ? 2 : 1,
                    Directions.South =&gt; 1,
                    Directions.North =&gt; 1,
                    Directions.West =&gt; right ? 1 : 2,
                    _ =&gt; 2
                },
                2 =&gt; CVisualization._direction switch
                {
                    Directions.South =&gt; right ? 1 : 2,
                    Directions.North =&gt; right ? 1 : 2,
                    Directions.West =&gt; 1,
                    _ =&gt; 2
                },
                _ =&gt; CVisualization._direction switch
                {
                    Directions.South =&gt; right ? 1 : 2,
                    Directions.North =&gt; right ? 1 : 2,
                    Directions.West =&gt; 0,
                    _ =&gt; 3
                }
            };
        }
        
        private static int ConvertDistanceForRightCorner(int distance, bool right)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            return newDistance switch
            {
                0 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; 0,
                    Directions.South =&gt; right ? 2 : 1,
                    Directions.North =&gt; right ? 2 : 1,
                    _ =&gt; 1
                },
                1 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; 1,
                    Directions.South =&gt; right ? 2 : 1,
                    Directions.North =&gt; right ? 2 : 1,
                    _ =&gt; 2
                },
                2 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; right ? 1 : 2,
                    Directions.South =&gt; 1,
                    Directions.West =&gt; right ? 2 : 3,
                    _ =&gt; 2
                },
                _ =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; right ? 1 : 2,
                    Directions.South =&gt; 0,
                    Directions.West =&gt; right ? 2 : 3,
                    _ =&gt; 3
                }
            };
        }

        private static int ConvertIndexForLeftCorner(int distance, bool left)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            return newDistance switch
            {
                0 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; left ? 1 : 2,
                    Directions.West =&gt; left ? 2 : 1,
                    _ =&gt; 0
                },
                1 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; left ? 1 : 2,
                    Directions.West =&gt; left ? 2 : 1,
                    _ =&gt; 1
                },
                2 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; 1,
                    Directions.South =&gt; left ? 1 : 2,
                    Directions.North =&gt; left ? 2 : 1,
                    _ =&gt; 2
                },
                _ =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; 0,
                    Directions.South =&gt; left ? 1 : 2,
                    Directions.North =&gt; left ? 2 : 1,
                    _ =&gt; 3
                }
            };
        }
        
        private static int ConvertDistanceForLeftCorner(int distance, bool left)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            return newDistance switch
            {
                0 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; 0,
                    Directions.South =&gt; left ? 2 : 1,
                    Directions.North =&gt; left ? 2 : 1,
                    _ =&gt; 1
                },
                1 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; 1,
                    Directions.South =&gt; left ? 2 : 1,
                    Directions.North =&gt; left ? 2 : 1,
                    _ =&gt; 2
                },
                2 =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; left ? 1 : 2,
                    Directions.West =&gt; left ? 2 : 3,
                    Directions.North =&gt; 1,
                    _ =&gt; 2
                },
                _ =&gt; CVisualization._direction switch
                {
                    Directions.East =&gt; left ? 1 : 2,
                    Directions.West =&gt; left ? 2 : 3,
                    Directions.North =&gt; 0,
                    _ =&gt; 3
                }
            };
        }
        
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,78,0],[40,9,41,62,0],[42,13,42,64,0],[44,9,45,56,0],[46,13,46,57,0],[47,13,47,58,0],[48,13,48,60,0],[52,9,53,64,0],[54,13,54,62,0],[56,13,56,67,0],[57,13,57,65,0],[59,13,59,66,0],[60,13,60,64,0],[62,13,62,66,0],[63,13,63,68,0],[65,13,65,68,0],[66,13,66,64,0],[68,13,68,65,0],[69,13,69,68,0],[71,13,71,65,0],[72,13,72,64,0],[76,9,76,10,0],[77,13,77,68,0],[78,9,78,10,0],[81,9,81,10,0],[82,13,82,54,0],[83,9,83,10,0],[86,9,86,10,0],[87,13,87,38,0],[88,13,89,71,0],[90,17,90,69,0],[92,13,92,57,0],[93,13,93,58,0],[94,13,94,29,0],[96,13,96,129,0],[97,13,97,43,0],[99,13,99,71,0],[100,13,100,124,0],[101,13,101,107,0],[103,13,103,20,0],[103,22,103,42,0],[103,43,103,45,0],[103,46,103,60,0],[104,13,104,14,0],[105,17,105,98,0],[106,13,106,14,0],[107,9,107,10,0],[110,9,110,10,0],[111,13,111,92,0],[112,13,112,14,0],[113,17,113,58,0],[116,13,117,83,0],[118,17,118,83,0],[120,13,120,116,0],[121,13,121,14,0],[122,17,122,63,0],[125,13,125,106,0],[127,13,127,54,0],[128,9,128,10,0],[131,9,131,10,0],[132,13,132,93,0],[133,13,133,14,0],[134,17,134,59,0],[137,13,138,85,0],[139,17,139,85,0],[141,13,141,118,0],[142,13,142,14,0],[143,17,143,64,0],[146,13,146,110,0],[148,13,148,55,0],[149,9,149,10,0],[152,9,152,10,0],[153,13,153,41,0],[156,21,156,48,0],[157,21,157,27,0],[159,21,159,47,0],[160,21,160,27,0],[162,21,162,49,0],[163,21,163,27,0],[165,21,165,50,0],[166,21,166,27,0],[168,21,168,45,0],[169,21,169,27,0],[171,21,171,90,0],[173,9,173,10,0],[176,9,176,10,0],[177,13,177,86,0],[178,9,178,10,0],[181,9,181,10,0],[182,13,182,47,0],[185,21,185,81,0],[186,21,186,66,0],[187,21,187,27,0],[189,21,189,82,0],[190,21,190,65,0],[191,21,191,27,0],[193,21,193,81,0],[194,21,194,66,0],[195,21,195,27,0],[197,21,197,80,0],[198,21,198,65,0],[199,21,199,27,0],[201,21,201,73,0],[204,13,204,47,0],[207,21,207,88,0],[208,21,208,87,0],[209,21,209,27,0],[211,21,211,62,0],[212,21,212,87,0],[213,21,213,27,0],[215,21,215,92,0],[216,21,216,27,0],[219,21,219,27,0],[221,9,221,10,0],[224,9,224,10,0],[225,13,225,47,0],[228,21,228,82,0],[229,21,229,66,0],[230,21,230,27,0],[232,21,232,83,0],[233,21,233,65,0],[234,21,234,27,0],[236,21,236,82,0],[237,21,237,66,0],[238,21,238,27,0],[240,21,240,81,0],[241,21,241,65,0],[242,21,242,27,0],[244,21,244,73,0],[247,13,247,47,0],[250,21,250,62,0],[251,21,251,87,0],[252,21,252,27,0],[254,21,254,88,0],[255,21,255,87,0],[256,21,256,27,0],[258,21,258,92,0],[259,21,259,27,0],[262,21,262,27,0],[264,9,264,10,0],[267,9,267,10,0],[268,13,268,54,0],[269,13,269,14,0],[270,17,270,83,0],[271,17,271,24,0],[274,13,274,81,0],[275,9,275,10,0],[278,9,278,10,0],[279,13,279,54,0],[280,13,280,14,0],[281,17,281,84,0],[282,17,282,24,0],[285,13,285,82,0],[286,9,286,10,0],[289,9,289,10,0],[290,13,290,54,0],[291,13,291,14,0],[292,17,292,81,0],[293,17,293,24,0],[296,13,296,79,0],[297,9,297,10,0],[300,9,300,10,0],[301,13,301,101,0],[302,13,302,14,0],[303,17,303,53,0],[304,13,304,14,0],[306,13,306,14,0],[307,17,307,51,0],[308,13,308,14,0],[310,13,310,47,0],[313,21,313,88,0],[314,21,314,87,0],[315,21,315,27,0],[317,21,317,88,0],[318,21,318,87,0],[319,21,319,27,0],[321,9,321,10,0],[324,9,324,10,0],[325,13,325,95,0],[327,13,327,20,0],[327,22,327,35,0],[327,36,327,38,0],[327,39,327,51,0],[328,13,328,14,0],[329,17,329,50,0],[330,17,330,54,0],[331,13,331,14,0],[332,9,332,10,0],[335,9,335,10,0],[336,13,336,95,0],[338,13,338,20,0],[338,22,338,35,0],[338,36,338,38,0],[338,39,338,51,0],[339,13,339,14,0],[340,17,340,50,0],[341,17,341,52,0],[342,13,342,14,0],[343,9,343,10,0],[346,9,346,10,0],[347,13,347,96,0],[348,13,348,14,0],[349,17,349,32,0],[352,13,352,81,0],[353,13,353,14,0],[354,17,354,87,0],[357,13,357,71,0],[358,13,358,14,0],[359,17,363,19,0],[366,13,370,15,0],[371,9,371,10,0],[374,9,374,10,0],[375,13,375,71,0],[376,13,376,14,0],[377,17,377,81,0],[378,17,378,18,0],[379,21,383,23,0],[386,17,390,19,0],[393,13,393,77,0],[394,13,394,14,0],[395,17,398,19,0],[401,13,404,15,0],[405,9,405,10,0],[408,9,408,10,0],[409,13,410,128,0],[411,17,411,129,0],[412,17,412,134,0],[413,17,413,135,0],[415,13,416,92,0],[417,17,417,93,0],[419,13,419,124,0],[420,13,420,124,0],[422,13,422,28,0],[423,9,423,10,0],[426,9,426,10,0],[427,13,428,129,0],[429,17,429,130,0],[430,17,430,135,0],[431,17,431,136,0],[433,13,434,92,0],[435,17,435,93,0],[437,13,437,124,0],[438,13,438,124,0],[440,13,440,28,0],[441,9,441,10,0],[444,9,444,10,0],[445,13,445,121,0],[446,17,446,130,0],[448,13,450,15,0],[452,13,452,28,0],[453,9,453,10,0],[456,9,456,10,0],[457,13,457,122,0],[458,17,458,131,0],[460,13,462,15,0],[464,13,464,28,0],[465,9,465,10,0],[468,9,468,10,0],[469,13,469,54,0],[470,13,470,14,0],[471,17,471,141,0],[474,13,474,139,0],[475,9,475,10,0],[478,9,478,10,0],[479,13,479,54,0],[480,13,480,14,0],[481,17,481,111,0],[484,13,484,103,0],[485,9,485,10,0],[488,9,488,10,0],[489,13,489,114,0],[490,13,490,114,0],[491,13,491,30,0],[492,13,492,14,0],[493,17,493,30,0],[494,13,494,14,0],[496,13,496,30,0],[497,13,497,14,0],[498,17,498,30,0],[499,13,499,14,0],[501,13,502,96,0],[503,17,503,96,0],[504,17,504,47,0],[505,17,505,47,0],[507,13,507,114,0],[508,13,508,114,0],[510,13,510,28,0],[511,9,511,10,0],[514,9,514,10,0],[515,13,515,96,0],[516,17,516,96,0],[517,13,518,96,0],[519,17,519,96,0],[520,17,520,47,0],[521,17,521,47,0],[523,13,523,117,0],[524,13,524,117,0],[526,13,526,28,0],[527,9,527,10,0],[530,9,530,10,0],[531,13,531,108,0],[532,13,532,27,0],[533,13,533,14,0],[534,17,534,27,0],[535,13,535,14,0],[537,13,537,89,0],[539,13,539,116,0],[541,13,541,28,0],[542,9,542,10,0],[545,9,545,10,0],[546,13,546,94,0],[548,13,550,15,0],[552,13,552,28,0],[553,9,553,10,0],[556,9,556,10,0],[557,13,557,51,0],[558,9,558,10,0],[561,9,561,10,0],[562,13,562,51,0],[563,9,563,10,0],[566,9,566,10,0],[567,13,567,112,0],[568,13,568,39,0],[569,9,569,10,0],[572,9,572,10,0],[573,13,573,92,0],[575,13,575,104,0],[576,9,576,10,0],[579,9,579,10,0],[580,13,580,141,0],[581,13,581,79,0],[583,13,583,58,0],[584,13,584,68,0],[585,13,585,14,0],[586,17,586,92,0],[587,13,587,14,0],[589,13,589,71,0],[590,13,590,14,0],[591,17,591,31,0],[594,13,594,101,0],[595,9,595,10,0],[598,9,598,10,0],[599,13,599,103,0],[600,9,600,10,0],[603,9,603,10,0],[604,13,604,62,0],[605,13,605,14,0],[606,17,606,120,0],[607,13,607,14,0],[609,13,609,29,0],[610,9,610,10,0],[613,9,613,10,0],[614,13,614,66,0],[615,9,615,10,0],[618,9,618,10,0],[619,13,619,87,0],[620,9,620,10,0],[623,9,623,10,0],[624,13,624,114,0],[625,13,627,22,0],[627,22,629,40,0],[629,40,629,53,0],[629,53,630,41,0],[630,41,630,42,0],[630,42,631,41,0],[631,41,631,42,0],[631,42,632,40,0],[632,40,632,53,0],[632,53,633,26,0],[633,26,633,27,0],[633,27,634,18,0],[634,18,635,22,0],[635,22,637,40,0],[637,40,637,53,0],[637,53,638,41,0],[638,41,638,42,0],[638,42,639,41,0],[639,41,639,42,0],[639,42,640,40,0],[640,40,640,53,0],[640,53,641,26,0],[641,26,641,27,0],[641,27,642,18,0],[642,18,643,22,0],[643,22,645,41,0],[645,41,645,54,0],[645,54,646,41,0],[646,41,646,54,0],[646,54,647,40,0],[647,40,647,41,0],[647,41,648,26,0],[648,26,648,27,0],[648,27,649,18,0],[649,18,650,22,0],[650,22,652,41,0],[652,41,652,54,0],[652,54,653,41,0],[653,41,653,54,0],[653,54,654,40,0],[654,40,654,41,0],[654,41,655,26,0],[655,26,655,27,0],[655,27,656,18,0],[656,18,657,15,0],[658,9,658,10,0],[661,9,661,10,0],[662,13,662,114,0],[663,13,665,22,0],[665,22,667,40,0],[667,40,667,41,0],[667,41,668,41,0],[668,41,668,54,0],[668,54,669,41,0],[669,41,669,54,0],[669,54,670,26,0],[670,26,670,27,0],[670,27,671,18,0],[671,18,672,22,0],[672,22,674,40,0],[674,40,674,41,0],[674,41,675,41,0],[675,41,675,54,0],[675,54,676,41,0],[676,41,676,54,0],[676,54,677,26,0],[677,26,677,27,0],[677,27,678,18,0],[678,18,679,22,0],[679,22,681,40,0],[681,40,681,53,0],[681,53,682,41,0],[682,41,682,42,0],[682,42,683,40,0],[683,40,683,53,0],[683,53,684,26,0],[684,26,684,27,0],[684,27,685,18,0],[685,18,686,22,0],[686,22,688,40,0],[688,40,688,53,0],[688,53,689,41,0],[689,41,689,42,0],[689,42,690,40,0],[690,40,690,53,0],[690,53,691,26,0],[691,26,691,27,0],[691,27,692,18,0],[692,18,693,15,0],[694,9,694,10,0],[697,9,697,10,0],[698,13,698,114,0],[699,13,701,22,0],[701,22,703,40,0],[703,40,703,52,0],[703,52,704,40,0],[704,40,704,52,0],[704,52,705,26,0],[705,26,705,27,0],[705,27,706,18,0],[706,18,707,22,0],[707,22,709,40,0],[709,40,709,52,0],[709,52,710,40,0],[710,40,710,52,0],[710,52,711,26,0],[711,26,711,27,0],[711,27,712,18,0],[712,18,713,22,0],[713,22,715,40,0],[715,40,715,41,0],[715,41,716,41,0],[716,41,716,53,0],[716,53,717,41,0],[717,41,717,53,0],[717,53,718,26,0],[718,26,718,27,0],[718,27,719,18,0],[719,18,720,22,0],[720,22,722,40,0],[722,40,722,41,0],[722,41,723,41,0],[723,41,723,53,0],[723,53,724,41,0],[724,41,724,53,0],[724,53,725,26,0],[725,26,725,27,0],[725,27,726,18,0],[726,18,727,15,0],[728,9,728,10,0],[731,9,731,10,0],[732,13,732,114,0],[733,13,735,22,0],[735,22,737,40,0],[737,40,737,41,0],[737,41,738,41,0],[738,41,738,53,0],[738,53,739,41,0],[739,41,739,53,0],[739,53,740,26,0],[740,26,740,27,0],[740,27,741,18,0],[741,18,742,22,0],[742,22,744,40,0],[744,40,744,41,0],[744,41,745,41,0],[745,41,745,53,0],[745,53,746,41,0],[746,41,746,53,0],[746,53,747,26,0],[747,26,747,27,0],[747,27,748,18,0],[748,18,749,22,0],[749,22,751,40,0],[751,40,751,52,0],[751,52,752,40,0],[752,40,752,52,0],[752,52,753,41,0],[753,41,753,42,0],[753,42,754,26,0],[754,26,754,27,0],[754,27,755,18,0],[755,18,756,22,0],[756,22,758,40,0],[758,40,758,52,0],[758,52,759,40,0],[759,40,759,52,0],[759,52,760,41,0],[760,41,760,42,0],[760,42,761,26,0],[761,26,761,27,0],[761,27,762,18,0],[762,18,763,15,0],[764,9,764,10,0]]);
    </script>
  </body>
</html>