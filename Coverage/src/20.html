<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\Development\C#\RaceSimulator\RaceSimulator\CVisualization.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Controller;
using Model;

namespace RaceSimulator
{
    public static class CVisualization
    {

        private const Directions StartDirection = Directions.East;
        private static Directions _direction = CVisualization.StartDirection;

        private const int
            TrackPositionUndefined = -1,
            SymbolSpaces = 4,

            /*
             * The first property determines the max length of the initials and trims the initials
             * to the selected length. The second property determines the index of the initials
             * inside a string of the graphics strings.
             *
             * If we have the string: &quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot; for example, the initials
             * will be placed on the selected position. The third and fourth property determines
             * which string of the symbols we have to take. 
             *
             * If the value of the first property is 0, and of the second 1 and of the third 2,
             * the output will be this: &quot;----&quot;, &quot;AB| &quot;, &quot;CD| &quot;, &quot;----&quot; or &quot;----&quot;, &quot;A | &quot;, &quot;BC| &quot;, &quot;----&quot;
             * or &quot;----&quot;, &quot;AB| &quot;, &quot;  | &quot;, &quot;----&quot;.
             */
            MaxInitialsLength = 1,
            InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex = 1,
            InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex = 2;

        private static readonly int
            CursorStartEastPosition = Console.WindowWidth / 2, 
            CursorStartNorthPosition = Console.WindowHeight / 2;

        private static int
            _trackEastPosition = TrackPositionUndefined,
            _trackNorthPosition = TrackPositionUndefined,
            _cursorEastPosition = CursorStartEastPosition,
            _cursorNorthPosition = CursorStartNorthPosition;

        #region graphics

        private static readonly string[]
            FinishHorizontal = {&quot;----&quot;, &quot;  # &quot;, &quot;  # &quot;, &quot;----&quot;},
            FinishVertical = {&quot;|  |&quot;, &quot;|##|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StartGridHorizontal = {&quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot;},
            StartGridVertical = {&quot;|  |&quot;, &quot;|--|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StraightHorizontal = {&quot;----&quot;, &quot;    &quot;, &quot;    &quot;, &quot;----&quot;},
            StraightVertical = {&quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            NorthCornerToRight = {&quot;|  /&quot;, &quot;|   &quot;, &quot;/   &quot;, &quot; /--&quot;},
            NorthCornerToLeft = {&quot;\\  |&quot;, &quot;   |&quot;, &quot;   \\&quot;, &quot;--\\ &quot;},

            EastCornerToRight = {&quot;--\\ &quot;, &quot;   \\&quot;, &quot;   |&quot;, &quot;\\  |&quot;},
            EastCornerToLeft = {&quot;/  |&quot;, &quot;   |&quot;, &quot;   /&quot;, &quot;--/ &quot;},

            SouthCornerToRight = CVisualization.EastCornerToLeft,
            SouthCornerToLeft = {&quot;|  \\&quot;, &quot;|   &quot;, &quot;\\   &quot;, &quot; \\--&quot;},

            WestCornerToRight = CVisualization.SouthCornerToLeft,
            WestCornerToLeft = {&quot; /--&quot;, &quot;/   &quot;, &quot;|   &quot;, &quot;|  /&quot;};
        #endregion

        public static void Initialize()
        {
            Race.DriversChanged += CVisualization.OnDriversChanged;
        }

        private static void OnDriversChanged(object sender, DriversChangedEventArgs eventArgs)
        {
            CVisualization.DrawTrack(eventArgs.Race);
        }

        public static void DrawTrack(Race race)
        {
            Track track = race.Track;
            int northPosition = CVisualization.GetNorthPosition(track), eastPosition = CVisualization.GetEastPosition(track);
            
            Console.BackgroundColor = ConsoleColor.Blue;
            Console.ForegroundColor = ConsoleColor.White;
            Console.Clear();

            Console.SetCursorPosition(CenteredTextCursorStartPosition(track.Name),  northPosition &lt; 20 ? CVisualization.CursorStartNorthPosition - 4 :  northPosition - 4);
            Console.WriteLine(track.Name);
            
            CVisualization._direction = CVisualization.StartDirection;
            CVisualization._cursorEastPosition = eastPosition &lt; 20 ? CVisualization.CursorStartEastPosition : eastPosition;
            CVisualization._cursorNorthPosition = northPosition &lt; 20 ? CVisualization.CursorStartNorthPosition :  northPosition;

            foreach (Section trackSection in track.Sections)
            {
                CVisualization.DrawTrackSection(trackSection, race.GetSectionData(trackSection));
            }
        }
        
        private static int GetEastPosition(Track track)
        {
            if (CVisualization._trackEastPosition != CVisualization.TrackPositionUndefined)
            {
                return CVisualization._trackEastPosition;
            }
            
            int eastPosition = (track.GetWestwardSectionsCount() * CVisualization.SymbolSpaces) + CVisualization.SymbolSpaces;
            
            if (eastPosition == Track.SectionCountUndefined)
            {
                return CVisualization.CursorStartEastPosition;
            }
            
            return eastPosition;
        }

        private static int GetNorthPosition(Track track)
        {
            if (CVisualization._trackNorthPosition != CVisualization.TrackPositionUndefined)
            {
                return CVisualization._trackNorthPosition;
            }
            
            int northPosition = (track.GetNorthwardSectionsCount() * CVisualization.SymbolSpaces) - (track.GetSouthwardSectionsCount() * CVisualization.SymbolSpaces) + CVisualization.SymbolSpaces;
            
            if (northPosition == Track.SectionCountUndefined)
            {
                return CVisualization.CursorStartNorthPosition;
            }
            
            return northPosition + CVisualization.SymbolSpaces;
        }

        private static void DrawTrackSection(Section section, SectionData sectionData)
        {
            switch (section.SectionType)
            {
                case SectionTypes.StartGrid:
                    DrawStartGrid(sectionData);
                    break;
                case SectionTypes.Straight:
                    DrawStraight(sectionData);
                    break;
                case SectionTypes.LeftCorner:
                    DrawLeftCorner(sectionData);
                    break;
                case SectionTypes.RightCorner:
                    DrawRightCorner(sectionData);
                    break;
                case SectionTypes.Finish:
                    DrawFinish(sectionData);
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;Unknown section type given!&quot;);
            }
        }

        private static bool DirectionIsVertical()
        {
            return CVisualization._direction is Directions.South or Directions.North;
        }

        private static void DrawLeftCorner(SectionData sectionData = null)
        {
            if (CVisualization._direction == Directions.East)
            {
                DrawDownwards(CVisualization.EastCornerToLeft, sectionData);
                CVisualization._direction = Directions.North;
            }
            else if (CVisualization._direction == Directions.South)
            {
                DrawDownwards(CVisualization.SouthCornerToLeft, sectionData);
                CVisualization._direction = Directions.East;
            }
            else if (CVisualization._direction == Directions.West)
            {
                DrawDownwards(CVisualization.WestCornerToLeft, sectionData);
                CVisualization._direction = Directions.South;
            }
            else if (CVisualization._direction == Directions.North)
            {
                DrawUpwards(CVisualization.NorthCornerToLeft, sectionData);
                CVisualization._direction = Directions.West;
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawRightCorner(SectionData sectionData = null)
        {
            if (CVisualization._direction == Directions.East)
            {
                DrawDownwards(CVisualization.EastCornerToRight, sectionData);
                CVisualization._direction = Directions.South;
            }
            else if (CVisualization._direction == Directions.South)
            {
                DrawDownwards(CVisualization.SouthCornerToRight, sectionData);
                CVisualization._direction = Directions.West;
            }
            else if (CVisualization._direction == Directions.West)
            {
                DrawDownwards(CVisualization.WestCornerToRight, sectionData);
                CVisualization._direction = Directions.North;
            }
            else if (CVisualization._direction == Directions.North)
            {
                DrawUpwards(CVisualization.NorthCornerToRight, sectionData);
                CVisualization._direction = Directions.East;
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawStraight(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StraightVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StraightHorizontal, sectionData);
        }

        private static void DrawStartGrid(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StartGridVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StartGridHorizontal, sectionData);
        }

        private static void DrawFinish(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.FinishVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.FinishHorizontal, sectionData);
        }

        private static void Draw(string[] symbols, SectionData sectionData = null)
        {
            if (CVisualization._direction is Directions.East or Directions.West or Directions.South)
            {
                DrawDownwards(symbols, sectionData);
            }
            else
            {
                DrawUpwards(symbols, sectionData);
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
            }
        }

        private static void DrawDownwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorDownwards();
            }
        }

        private static void DrawUpwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorUpwards();
            }
        }

        private static string[] SectionDataToSymbols(string[] symbols, SectionData sectionData = null)
        {
            if (sectionData == null || (sectionData.Left == null &amp;&amp; sectionData.Right == null))
            {
                return symbols;
            }

            if (CVisualization.SectionIsCorner(sectionData.Section.SectionType))
            {
                return CVisualization.PlaceParticipantsOnCorner(symbols, sectionData);
            }
            
            if (sectionData.Left != null &amp;&amp; sectionData.Right != null)
            {
                return CVisualization.PlaceParticipantsOnSection(
                    symbols.ToArray(), 
                    sectionData.Left, sectionData.DistanceLeft, 
                    sectionData.Right, sectionData.DistanceRight
                );
            }

            return CVisualization.PlaceParticipantOnSection(
                symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight,
                sectionData.Left != null
            );
        }

        private static string[] PlaceParticipantsOnCorner(string[] symbols, SectionData sectionData)
        {
            if (sectionData.Left != null &amp;&amp; sectionData.Right != null)
            {
                if (sectionData.Section.SectionType == SectionTypes.RightCorner)
                {
                    return CVisualization.PlaceParticipantsOnRightCorner(
                        symbols.ToArray(), 
                        sectionData.Left, sectionData.DistanceLeft, 
                        sectionData.Right, sectionData.DistanceRight
                    );
                }
                
                return CVisualization.PlaceParticipantsOnLeftCorner(
                    symbols.ToArray(), 
                    sectionData.Left, sectionData.DistanceLeft, 
                    sectionData.Right, sectionData.DistanceRight
                );
            }

            if (sectionData.Section.SectionType == SectionTypes.RightCorner)
            {
                return CVisualization.PlaceParticipantOnRightCorner(
                    symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                    sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight
                );
            }
            
            return CVisualization.PlaceParticipantOnLeftCorner(
                symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight
            );
        }

        private static string[] PlaceParticipantsOnLeftCorner(string[] symbols,IParticipant participantLeft, int distanceLeft, IParticipant participantRight, int distanceRight)
        {
            int
                indexOne = CVisualization.ConvertIndexForLeftCorner(distanceLeft, CVisualization._direction == Directions.East),
                indexTwo = CVisualization.ConvertIndexForLeftCorner(distanceRight, CVisualization._direction != Directions.East),
                distanceOne = CVisualization.ConvertDistanceForLeftCorner(distanceLeft, CVisualization._direction == Directions.East),
                distanceTwo = CVisualization.ConvertDistanceForLeftCorner(distanceRight, CVisualization._direction != Directions.East);

            string
                initialsOne = participantLeft.GetInitials(CVisualization.MaxInitialsLength),
                initialsTwo = participantRight.GetInitials(CVisualization.MaxInitialsLength);

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexTwo], initialsTwo, distanceTwo);
            
            return symbols;
        }

        private static string[] PlaceParticipantsOnRightCorner(string[] symbols,IParticipant participantLeft, int distanceLeft, IParticipant participantRight, int distanceRight)
        {
            int
                indexOne = CVisualization.ConvertIndexForRightCorner(distanceLeft, CVisualization._direction == Directions.West),
                indexTwo = CVisualization.ConvertIndexForRightCorner(distanceRight, CVisualization._direction != Directions.West),
                distanceOne = CVisualization.ConvertDistanceForRightCorner(distanceLeft, CVisualization._direction == Directions.West),
                distanceTwo = CVisualization.ConvertDistanceForRightCorner(distanceRight, CVisualization._direction != Directions.West);

            string
                initialsOne = participantLeft.GetInitials(CVisualization.MaxInitialsLength),
                initialsTwo = participantRight.GetInitials(CVisualization.MaxInitialsLength);

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexTwo], initialsTwo, distanceTwo);
            
            return symbols;
        }

        private static string[] PlaceParticipantOnLeftCorner(string[] symbols, IParticipant participant, int distance)
        {
            int index = CVisualization.ConvertIndexForLeftCorner(distance, CVisualization._direction == Directions.East),
                distanceOne = CVisualization.ConvertDistanceForLeftCorner(distance, CVisualization._direction == Directions.East);

            symbols[index] = CVisualization.MergeInitialsIntoSymbolByIndex(
                symbols[index], participant.GetInitials(CVisualization.MaxInitialsLength), distanceOne
            );

            return symbols;
        }

        private static string[] PlaceParticipantOnRightCorner(string[] symbols, IParticipant participant, int distance)
        {
            int index = CVisualization.ConvertIndexForRightCorner(distance, CVisualization._direction == Directions.West),
                distanceOne = CVisualization.ConvertDistanceForRightCorner(distance, CVisualization._direction == Directions.West);

            symbols[index] = CVisualization.MergeInitialsIntoSymbolByIndex(
                symbols[index], participant.GetInitials(CVisualization.MaxInitialsLength), distanceOne
            );

            return symbols;
        }
        
        private static string[] PlaceParticipantsOnSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            if (CVisualization.DirectionIsVertical())
            {
                return CVisualization.PlaceParticipantsOnVerticalSection(symbols, participantOne, distanceOne, participantTwo, distanceTwo);
            }
            
            return CVisualization.PlaceParticipantsOnHorizontalSection(symbols, participantOne, distanceOne, participantTwo, distanceTwo);
        }
        
        private static string[] PlaceParticipantOnSection(string[] symbols, IParticipant participant, int distance, bool left)
        {
            if (CVisualization.DirectionIsVertical())
            {
                return CVisualization.PlaceParticipantOnVerticalSection(symbols, participant, distance, left);
            }
            
            return CVisualization.PlaceParticipantOnHorizontalSection(symbols, participant, distance);
        }

        private static string[] PlaceParticipantsOnVerticalSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            int indexOne = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distanceOne);
            int indexTwo = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distanceTwo);
            if (indexOne &gt; 3)
            {
                indexOne = 3;
            }

            if (indexTwo &gt; 3)
            {
                indexTwo = 3;
            }
            
            string
                initialsStartOne = participantOne.GetInitials(CVisualization.MaxInitialsLength),
                initialsStartTwo = participantTwo.GetInitials(CVisualization.MaxInitialsLength),
                initialsOne = initialsStartOne,
                initialsTwo = initialsStartTwo;
            
            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexOne], initialsOne, 2);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexTwo], initialsTwo, 1);
            
            return symbols;
        }

        private static string[] PlaceParticipantsOnHorizontalSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            int indexOne = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex,
                indexTwo = CVisualization.InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex;
            string
                initialsStartOne = participantOne.GetInitials(CVisualization.MaxInitialsLength),
                initialsStartTwo = participantTwo.GetInitials(CVisualization.MaxInitialsLength),
                initialsOne = initialsStartOne,
                initialsTwo = initialsStartTwo;

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbol(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbol(symbols[indexTwo], initialsTwo, distanceTwo);

            return symbols;
        }
        
        private static string[] PlaceParticipantOnVerticalSection(string[] symbols, IParticipant participant, int distance, bool left)
        {
            int index = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            if (index &gt; 3)
            {
                index = 3;
            }

            string initials = participant.GetInitials(CVisualization.MaxInitialsLength);
            
            symbols[index] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[index], initials, left ? 2 : 1);
            
            return symbols;
        }

        private static string[] PlaceParticipantOnHorizontalSection(string[] symbols, IParticipant participant, int distance)
        {
            int index = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex;

            symbols[index] = CVisualization.MergeInitialsIntoSymbol(
                symbols[index], participant.GetInitials(CVisualization.MaxInitialsLength), distance
            );

            return symbols;
        }

        private static void MoveCursorUpwards()
        {
            CVisualization._cursorNorthPosition--;
        }

        private static void MoveCursorDownwards()
        {
            CVisualization._cursorNorthPosition++;
        }

        private static void WriteLine(string symbol)
        {
            Console.SetCursorPosition(CVisualization._cursorEastPosition, CVisualization._cursorNorthPosition);
            Console.WriteLine(symbol);
        }

        private static string MergeInitialsIntoSymbol(string symbol, string initials, int distance)
        { 
            int initialsStartIndex = CVisualization.ConvertDistanceToSymbolIndex(distance);

            return CVisualization.MergeInitialsIntoSymbolByIndex(symbol, initials, initialsStartIndex);
        }

        private static string MergeInitialsIntoSymbolByIndex(string symbol, string initials, int index)
        {
            int maxInitialsLength = initials.Length &lt; CVisualization.MaxInitialsLength ? initials.Length : CVisualization.MaxInitialsLength;
            int startIndex = CVisualization.FlipSymbolIndexIfNecessary(index);

            string trimmedInitials = initials.ToString();
            if (initials.Length &gt; CVisualization.MaxInitialsLength)
            {
                trimmedInitials = trimmedInitials.Remove(CVisualization.MaxInitialsLength);
            }

            if ((trimmedInitials.Length + startIndex) &gt; symbol.Length)
            {
                return symbol;
            }

            return symbol.Remove(startIndex, maxInitialsLength).Insert(startIndex, trimmedInitials);
        }

        private static int ConvertDistanceToSymbolIndex(int distance)
        {
            return Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
        }

        private static int FlipSymbolIndexIfNecessary(int distance)
        {
            if (CVisualization._direction == Directions.West)
            {
                distance = Race.ConvertRange(0, CVisualization.SymbolSpaces, CVisualization.SymbolSpaces, 0, distance);
            }

            return distance;
        }
        
        private static int CenteredTextCursorStartPosition(string text)
        {
            return (Console.WindowWidth / 2) - (text.Length / 2);
        }

        private static bool SectionIsCorner(SectionTypes sectionType)
        {
            return sectionType == SectionTypes.LeftCorner || sectionType == SectionTypes.RightCorner;
        }
        
        private static int ConvertIndexForRightCorner(int distance, bool right)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            switch (newDistance)
            {
                case 0:
                    if (CVisualization._direction == Directions.East)
                    {
                        return right ? 2 : 1;
                    }

                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return 0;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return right ? 1 : 2;
                    }

                    return 2;
                case 1:
                    if (CVisualization._direction == Directions.East)
                    {
                        return right ? 2 : 1;
                    }

                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return 1;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return right ? 1 : 2;
                    }
                    
                    return 2;
                case 2:
                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return right ? 1 : 2;
                    }
                    
                    if (CVisualization._direction == Directions.West)
                    {
                        return 1;
                    }
                    
                    return 2;
                default:
                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return right ? 1 : 2;
                    }
                    
                    if (CVisualization._direction == Directions.West)
                    {
                        return 0;
                    }

                    return 3;
            }
        }
        
        private static int ConvertDistanceForRightCorner(int distance, bool right)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            switch (newDistance)
            {
                case 0:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 0;
                    }

                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return right ? 2 : 1;
                    }

                    return 1;
                case 1:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 1;
                    }
                    
                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return right ? 2 : 1;
                    }

                    return 2;
                case 2:
                    if (CVisualization._direction == Directions.East)
                    {
                        return right ? 1 : 2;
                    }
                    
                    if (CVisualization._direction == Directions.South)
                    {
                        return 1;
                    }
                    
                    if (CVisualization._direction == Directions.West)
                    {
                        return right ? 2 : 3;
                    }

                    return 2;
                default:
                    if (CVisualization._direction == Directions.East)
                    {
                        return right ? 1 : 2;
                    }
                    
                    if (CVisualization._direction == Directions.South)
                    {
                        return 0;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return right ? 2 : 3;
                    }

                    return 3;
            }
        }

        private static int ConvertIndexForLeftCorner(int distance, bool left)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            switch (newDistance)
            {
                case 0:
                    if (CVisualization._direction == Directions.East)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return left ? 2 : 1;
                    }

                    return 0;
                case 1:
                    if (CVisualization._direction == Directions.East)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return left ? 2 : 1;
                    }
                    
                    return 1;
                case 2:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 1;
                    }

                    if (CVisualization._direction == Directions.South)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.North)
                    {
                        return left ? 2 : 1;
                    }
                    
                    return 2;
                default:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 0;
                    }
                    
                    if (CVisualization._direction == Directions.South)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.North)
                    {
                        return left ? 2 : 1;
                    }

                    return 3;
            }
        }
        
        private static int ConvertDistanceForLeftCorner(int distance, bool left)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            switch (newDistance)
            {
                case 0:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 0;
                    }

                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return left ? 2 : 1;
                    }

                    return 1;
                case 1:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 1;
                    }
                    
                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return left ? 2 : 1;
                    }

                    return 2;
                case 2:
                    if (CVisualization._direction == Directions.East)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return left ? 2 : 3;
                    }

                    if (CVisualization._direction == Directions.North)
                    {
                        return 1;
                    }
                    
                    return 2;
                default:
                    if (CVisualization._direction == Directions.East)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return left ? 2 : 3;
                    }

                    if (CVisualization._direction == Directions.North)
                    {
                        return 0;
                    }
                    
                    return 3;
            }
        }
        
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,78,0],[40,9,41,62,0],[42,13,42,64,0],[44,9,45,56,0],[46,13,46,57,0],[47,13,47,58,0],[48,13,48,60,0],[52,9,53,64,0],[54,13,54,62,0],[56,13,56,67,0],[57,13,57,65,0],[59,13,59,66,0],[60,13,60,64,0],[62,13,62,66,0],[63,13,63,68,0],[65,13,65,68,0],[66,13,66,64,0],[68,13,68,65,0],[69,13,69,68,0],[71,13,71,65,0],[72,13,72,64,0],[76,9,76,10,0],[77,13,77,68,0],[78,9,78,10,0],[81,9,81,10,0],[82,13,82,54,0],[83,9,83,10,0],[86,9,86,10,0],[87,13,87,38,0],[88,13,88,71,0],[88,73,88,125,0],[90,13,90,57,0],[91,13,91,58,0],[92,13,92,29,0],[94,13,94,172,0],[95,13,95,43,0],[97,13,97,71,0],[98,13,98,124,0],[99,13,99,129,0],[101,13,101,20,0],[101,22,101,42,0],[101,43,101,45,0],[101,46,101,60,0],[102,13,102,14,0],[103,17,103,98,0],[104,13,104,14,0],[105,9,105,10,0],[108,9,108,10,0],[109,13,109,92,0],[110,13,110,14,0],[111,17,111,58,0],[114,13,114,127,0],[116,13,116,61,0],[117,13,117,14,0],[118,17,118,63,0],[121,13,121,33,0],[122,9,122,10,0],[125,9,125,10,0],[126,13,126,93,0],[127,13,127,14,0],[128,17,128,59,0],[131,13,131,197,0],[133,13,133,62,0],[134,13,134,14,0],[135,17,135,64,0],[138,13,138,64,0],[139,9,139,10,0],[142,9,142,10,0],[143,13,143,41,0],[146,21,146,48,0],[147,21,147,27,0],[149,21,149,47,0],[150,21,150,27,0],[152,21,152,49,0],[153,21,153,27,0],[155,21,155,50,0],[156,21,156,27,0],[158,21,158,45,0],[159,21,159,27,0],[161,21,161,90,0],[163,9,163,10,0],[166,9,166,10,0],[167,13,167,86,0],[168,9,168,10,0],[171,9,171,10,0],[172,13,172,62,0],[173,13,173,14,0],[174,17,174,77,0],[175,17,175,62,0],[176,13,176,14,0],[177,18,177,68,0],[178,13,178,14,0],[179,17,179,78,0],[180,17,180,61,0],[181,13,181,14,0],[182,18,182,67,0],[183,13,183,14,0],[184,17,184,77,0],[185,17,185,62,0],[186,13,186,14,0],[187,18,187,68,0],[188,13,188,14,0],[189,17,189,76,0],[190,17,190,61,0],[191,13,191,14,0],[193,13,193,47,0],[196,21,196,88,0],[197,21,197,87,0],[198,21,198,27,0],[200,21,200,62,0],[201,21,201,87,0],[202,21,202,27,0],[204,21,204,92,0],[205,21,205,27,0],[208,21,208,27,0],[210,9,210,10,0],[213,9,213,10,0],[214,13,214,62,0],[215,13,215,14,0],[216,17,216,78,0],[217,17,217,62,0],[218,13,218,14,0],[219,18,219,68,0],[220,13,220,14,0],[221,17,221,79,0],[222,17,222,61,0],[223,13,223,14,0],[224,18,224,67,0],[225,13,225,14,0],[226,17,226,78,0],[227,17,227,62,0],[228,13,228,14,0],[229,18,229,68,0],[230,13,230,14,0],[231,17,231,77,0],[232,17,232,61,0],[233,13,233,14,0],[235,13,235,47,0],[238,21,238,62,0],[239,21,239,87,0],[240,21,240,27,0],[242,21,242,88,0],[243,21,243,87,0],[244,21,244,27,0],[246,21,246,92,0],[247,21,247,27,0],[250,21,250,27,0],[252,9,252,10,0],[255,9,255,10,0],[256,13,256,54,0],[257,13,257,14,0],[258,17,258,83,0],[259,17,259,24,0],[262,13,262,81,0],[263,9,263,10,0],[266,9,266,10,0],[267,13,267,54,0],[268,13,268,14,0],[269,17,269,84,0],[270,17,270,24,0],[273,13,273,82,0],[274,9,274,10,0],[277,9,277,10,0],[278,13,278,54,0],[279,13,279,14,0],[280,17,280,81,0],[281,17,281,24,0],[284,13,284,79,0],[285,9,285,10,0],[288,9,288,10,0],[289,13,289,101,0],[290,13,290,14,0],[291,17,291,53,0],[292,13,292,14,0],[294,13,294,14,0],[295,17,295,51,0],[296,13,296,14,0],[298,13,298,47,0],[301,21,301,88,0],[302,21,302,87,0],[303,21,303,27,0],[305,21,305,88,0],[306,21,306,87,0],[307,21,307,27,0],[309,9,309,10,0],[312,9,312,10,0],[313,13,313,95,0],[315,13,315,20,0],[315,22,315,35,0],[315,36,315,38,0],[315,39,315,51,0],[316,13,316,14,0],[317,17,317,50,0],[318,17,318,54,0],[319,13,319,14,0],[320,9,320,10,0],[323,9,323,10,0],[324,13,324,95,0],[326,13,326,20,0],[326,22,326,35,0],[326,36,326,38,0],[326,39,326,51,0],[327,13,327,14,0],[328,17,328,50,0],[329,17,329,52,0],[330,13,330,14,0],[331,9,331,10,0],[334,9,334,10,0],[335,13,335,96,0],[336,13,336,14,0],[337,17,337,32,0],[340,13,340,81,0],[341,13,341,14,0],[342,17,342,87,0],[345,13,345,71,0],[346,13,346,14,0],[347,17,351,19,0],[354,13,358,15,0],[359,9,359,10,0],[362,9,362,10,0],[363,13,363,71,0],[364,13,364,14,0],[365,17,365,81,0],[366,17,366,18,0],[367,21,371,23,0],[374,17,378,19,0],[381,13,381,77,0],[382,13,382,14,0],[383,17,386,19,0],[389,13,392,15,0],[393,9,393,10,0],[396,9,396,10,0],[397,13,398,128,0],[399,17,399,129,0],[400,17,400,134,0],[401,17,401,135,0],[403,13,404,92,0],[405,17,405,93,0],[407,13,407,124,0],[408,13,408,124,0],[410,13,410,28,0],[411,9,411,10,0],[414,9,414,10,0],[415,13,416,129,0],[417,17,417,130,0],[418,17,418,135,0],[419,17,419,136,0],[421,13,422,92,0],[423,17,423,93,0],[425,13,425,124,0],[426,13,426,124,0],[428,13,428,28,0],[429,9,429,10,0],[432,9,432,10,0],[433,13,433,121,0],[434,17,434,130,0],[436,13,438,15,0],[440,13,440,28,0],[441,9,441,10,0],[444,9,444,10,0],[445,13,445,122,0],[446,17,446,131,0],[448,13,450,15,0],[452,13,452,28,0],[453,9,453,10,0],[456,9,456,10,0],[457,13,457,54,0],[458,13,458,14,0],[459,17,459,141,0],[462,13,462,139,0],[463,9,463,10,0],[466,9,466,10,0],[467,13,467,54,0],[468,13,468,14,0],[469,17,469,111,0],[472,13,472,103,0],[473,9,473,10,0],[476,9,476,10,0],[477,13,477,114,0],[478,13,478,114,0],[479,13,479,30,0],[480,13,480,14,0],[481,17,481,30,0],[482,13,482,14,0],[484,13,484,30,0],[485,13,485,14,0],[486,17,486,30,0],[487,13,487,14,0],[489,13,490,96,0],[491,17,491,96,0],[492,17,492,47,0],[493,17,493,47,0],[495,13,495,114,0],[496,13,496,114,0],[498,13,498,28,0],[499,9,499,10,0],[502,9,502,10,0],[503,13,503,96,0],[504,17,504,96,0],[505,13,506,96,0],[507,17,507,96,0],[508,17,508,47,0],[509,17,509,47,0],[511,13,511,117,0],[512,13,512,117,0],[514,13,514,28,0],[515,9,515,10,0],[518,9,518,10,0],[519,13,519,108,0],[520,13,520,27,0],[521,13,521,14,0],[522,17,522,27,0],[523,13,523,14,0],[525,13,525,89,0],[527,13,527,116,0],[529,13,529,28,0],[530,9,530,10,0],[533,9,533,10,0],[534,13,534,94,0],[536,13,538,15,0],[540,13,540,28,0],[541,9,541,10,0],[544,9,544,10,0],[545,13,545,51,0],[546,9,546,10,0],[549,9,549,10,0],[550,13,550,51,0],[551,9,551,10,0],[554,9,554,10,0],[555,13,555,112,0],[556,13,556,39,0],[557,9,557,10,0],[560,9,560,10,0],[561,13,561,92,0],[563,13,563,104,0],[564,9,564,10,0],[567,9,567,10,0],[568,13,568,141,0],[569,13,569,79,0],[571,13,571,58,0],[572,13,572,68,0],[573,13,573,14,0],[574,17,574,92,0],[575,13,575,14,0],[577,13,577,71,0],[578,13,578,14,0],[579,17,579,31,0],[582,13,582,101,0],[583,9,583,10,0],[586,9,586,10,0],[587,13,587,103,0],[588,9,588,10,0],[591,9,591,10,0],[592,13,592,62,0],[593,13,593,14,0],[594,17,594,120,0],[595,13,595,14,0],[597,13,597,29,0],[598,9,598,10,0],[601,9,601,10,0],[602,13,602,66,0],[603,9,603,10,0],[606,9,606,10,0],[607,13,607,102,0],[608,9,608,10,0],[611,9,611,10,0],[612,13,612,114,0],[613,13,613,33,0],[616,21,616,70,0],[617,21,617,22,0],[618,25,618,46,0],[621,21,621,120,0],[622,21,622,22,0],[623,25,623,34,0],[626,21,626,70,0],[627,21,627,22,0],[628,25,628,46,0],[631,21,631,30,0],[633,21,633,70,0],[634,21,634,22,0],[635,25,635,46,0],[638,21,638,120,0],[639,21,639,22,0],[640,25,640,34,0],[643,21,643,70,0],[644,21,644,22,0],[645,25,645,46,0],[648,21,648,30,0],[650,21,650,120,0],[651,21,651,22,0],[652,25,652,46,0],[655,21,655,70,0],[656,21,656,22,0],[657,25,657,34,0],[660,21,660,30,0],[662,21,662,120,0],[663,21,663,22,0],[664,25,664,46,0],[667,21,667,70,0],[668,21,668,22,0],[669,25,669,34,0],[672,21,672,30,0],[674,9,674,10,0],[677,9,677,10,0],[678,13,678,114,0],[679,13,679,33,0],[682,21,682,70,0],[683,21,683,22,0],[684,25,684,34,0],[687,21,687,120,0],[688,21,688,22,0],[689,25,689,46,0],[692,21,692,30,0],[694,21,694,70,0],[695,21,695,22,0],[696,25,696,34,0],[699,21,699,120,0],[700,21,700,22,0],[701,25,701,46,0],[704,21,704,30,0],[706,21,706,70,0],[707,21,707,22,0],[708,25,708,46,0],[711,21,711,71,0],[712,21,712,22,0],[713,25,713,34,0],[716,21,716,70,0],[717,21,717,22,0],[718,25,718,46,0],[721,21,721,30,0],[723,21,723,70,0],[724,21,724,22,0],[725,25,725,46,0],[728,21,728,71,0],[729,21,729,22,0],[730,25,730,34,0],[733,21,733,70,0],[734,21,734,22,0],[735,25,735,46,0],[738,21,738,30,0],[740,9,740,10,0],[743,9,743,10,0],[744,13,744,114,0],[745,13,745,33,0],[748,21,748,70,0],[749,21,749,22,0],[750,25,750,45,0],[753,21,753,70,0],[754,21,754,22,0],[755,25,755,45,0],[758,21,758,30,0],[760,21,760,70,0],[761,21,761,22,0],[762,25,762,45,0],[765,21,765,70,0],[766,21,766,22,0],[767,25,767,45,0],[770,21,770,30,0],[772,21,772,70,0],[773,21,773,22,0],[774,25,774,34,0],[777,21,777,71,0],[778,21,778,22,0],[779,25,779,45,0],[782,21,782,71,0],[783,21,783,22,0],[784,25,784,45,0],[787,21,787,30,0],[789,21,789,70,0],[790,21,790,22,0],[791,25,791,34,0],[794,21,794,71,0],[795,21,795,22,0],[796,25,796,45,0],[799,21,799,71,0],[800,21,800,22,0],[801,25,801,45,0],[804,21,804,30,0],[806,9,806,10,0],[809,9,809,10,0],[810,13,810,114,0],[811,13,811,33,0],[814,21,814,70,0],[815,21,815,22,0],[816,25,816,34,0],[819,21,819,120,0],[820,21,820,22,0],[821,25,821,45,0],[824,21,824,30,0],[826,21,826,70,0],[827,21,827,22,0],[828,25,828,34,0],[831,21,831,120,0],[832,21,832,22,0],[833,25,833,45,0],[836,21,836,30,0],[838,21,838,70,0],[839,21,839,22,0],[840,25,840,45,0],[843,21,843,70,0],[844,21,844,22,0],[845,25,845,45,0],[848,21,848,71,0],[849,21,849,22,0],[850,25,850,34,0],[853,21,853,30,0],[855,21,855,70,0],[856,21,856,22,0],[857,25,857,45,0],[860,21,860,70,0],[861,21,861,22,0],[862,25,862,45,0],[865,21,865,71,0],[866,21,866,22,0],[867,25,867,34,0],[870,21,870,30,0],[872,9,872,10,0]]);
    </script>
  </body>
</html>