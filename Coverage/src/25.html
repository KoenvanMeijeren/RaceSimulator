<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\Development\C#\RaceSimulator\RaceSimulator\CVisualization.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Controller;
using Model;

namespace RaceSimulator
{

    public enum Directions
    {
        North = 0,
        East = 1,
        South = 2,
        West = 3
    }

    public static class CVisualization
    {

        private static readonly Directions _startDirection = Directions.East;
        private static Directions _direction = CVisualization._startDirection;

        private const int
            SymbolSpaces = 4,

            /*
             * The first property determines the max length of the initials and trims the initials
             * to the selected length. The second property determines the index of the initials
             * inside a string of the graphics strings.
             *
             * If we have the string: &quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot; for example, the initials
             * will be placed on the selected position. The third and fourth property determines
             * which string of the symbols we have to take. 
             *
             * If the value of the first property is 0, and of the second 1 and of the third 2,
             * the output will be this: &quot;----&quot;, &quot;AB| &quot;, &quot;CD| &quot;, &quot;----&quot; or &quot;----&quot;, &quot;A | &quot;, &quot;BC| &quot;, &quot;----&quot;
             * or &quot;----&quot;, &quot;AB| &quot;, &quot;  | &quot;, &quot;----&quot;.
             */
            MaxInitialsLength = 2,
            InitialsInGraphicsSymbolHorizontalStartIndex = 0,
            InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex = 1,
            InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex = 2,
            InitialsInGraphicsSymbolVerticalStartIndex = 1,
            InitialsOnPositionOneInGraphicsSymbolsVerticalIndex = 2,
            InitialsOnPositionTwoInGraphicsSymbolsVerticalIndex = 3;

        private static readonly int
            CursorStartEastPosition = Console.WindowWidth / 2, 
            CursorStartNorthPosition = Console.WindowHeight / 2;

        private static int
            _cursorEastPosition = CursorStartEastPosition,
            _cursorNorthPosition = CursorStartNorthPosition;

        #region graphics

        private static readonly string[]
            FinishHorizontal = {&quot;----&quot;, &quot;  # &quot;, &quot;  # &quot;, &quot;----&quot;},
            FinishVertical = {&quot;|  |&quot;, &quot;|##|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StartGridHorizontal = {&quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot;},
            StartGridVertical = {&quot;|  |&quot;, &quot;|--|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StraightHorizontal = {&quot;----&quot;, &quot;    &quot;, &quot;    &quot;, &quot;----&quot;},
            StraightVertical = {&quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            NorthCornerToRight = {&quot;|  /&quot;, &quot;|   &quot;, &quot;/   &quot;, &quot; /--&quot;},
            NorthCornerToLeft = {&quot;\\  |&quot;, &quot;   |&quot;, &quot;   \\&quot;, &quot;--\\ &quot;},

            EastCornerToRight = {&quot;--\\ &quot;, &quot;   \\&quot;, &quot;   |&quot;, &quot;\\  |&quot;},
            EastCornerToLeft = {&quot;/  |&quot;, &quot;   |&quot;, &quot;   /&quot;, &quot;--/ &quot;},

            SouthCornerToRight = CVisualization.EastCornerToLeft,
            SouthCornerToLeft = {&quot;|  \\&quot;, &quot;|   &quot;, &quot;\\   &quot;, &quot; \\--&quot;},

            WestCornerToRight = CVisualization.SouthCornerToLeft,
            WestCornerToLeft = {&quot; /--&quot;, &quot;/   &quot;, &quot;|   &quot;, &quot;|  /&quot;};
        #endregion

        public static void Initialize()
        {
            Race.DriversChanged += CVisualization.OnDriversChanged;
        }

        public static void OnDriversChanged(object sender, DriversChangedEventArgs eventArgs)
        {
            CVisualization.DrawTrack(eventArgs.Race);
        }

        public static void DrawTrack(Race race)
        {
            Track track = race.Track;

            Console.BackgroundColor = ConsoleColor.Blue;
            Console.ForegroundColor = ConsoleColor.White;
            Console.Clear();

            Console.SetCursorPosition(CenteredTextCursorStartPosition(track.Name), 1);
            Console.WriteLine(track.Name);

            if (track.EastStartPosition != Track.StartPositionUndefined)
            {
                CVisualization._cursorEastPosition = track.EastStartPosition;
            }

            if (track.NorthStartPosition != Track.StartPositionUndefined)
            {
                CVisualization._cursorNorthPosition = track.NorthStartPosition;
            }

            foreach (Section trackSection in track.Sections)
            {
                CVisualization.DrawTrackSection(trackSection, race.GetSectionData(trackSection));
            }
        }

        private static void DrawTrackSection(Section section, SectionData sectionData)
        {
            switch (section.SectionType)
            {
                case SectionTypes.StartGrid:
                    DrawStartGrid(sectionData);
                    break;
                case SectionTypes.Straight:
                    DrawStraight(sectionData);
                    break;
                case SectionTypes.LeftCorner:
                    DrawLeftCorner(sectionData);
                    break;
                case SectionTypes.RightCorner:
                    DrawRightCorner(sectionData);
                    break;
                case SectionTypes.Finish:
                    DrawFinish(sectionData);
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;Unknown section type given!&quot;);
            }
        }

        private static bool DirectionIsVertical()
        {
            return CVisualization._direction is Directions.South or Directions.North;
        }

        private static void DrawLeftCorner(SectionData sectionData = null)
        {
            if (CVisualization._direction == Directions.East)
            {
                DrawDownwards(CVisualization.EastCornerToLeft, sectionData);
                CVisualization._direction = Directions.North;
            }
            else if (CVisualization._direction == Directions.South)
            {
                DrawDownwards(CVisualization.SouthCornerToLeft, sectionData);
                CVisualization._direction = Directions.East;
            }
            else if (CVisualization._direction == Directions.West)
            {
                DrawDownwards(CVisualization.WestCornerToLeft, sectionData);
                CVisualization._direction = Directions.South;
            }
            else if (CVisualization._direction == Directions.North)
            {
                DrawUpwards(CVisualization.NorthCornerToLeft, sectionData);
                CVisualization._direction = Directions.West;
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawRightCorner(SectionData sectionData = null)
        {
            if (CVisualization._direction == Directions.East)
            {
                DrawDownwards(CVisualization.EastCornerToRight, sectionData);
                CVisualization._direction = Directions.South;
            }
            else if (CVisualization._direction == Directions.South)
            {
                DrawDownwards(CVisualization.SouthCornerToRight, sectionData);
                CVisualization._direction = Directions.West;
            }
            else if (CVisualization._direction == Directions.West)
            {
                DrawDownwards(CVisualization.WestCornerToRight, sectionData);
                CVisualization._direction = Directions.North;
            }
            else if (CVisualization._direction == Directions.North)
            {
                DrawUpwards(CVisualization.NorthCornerToRight, sectionData);
                CVisualization._direction = Directions.East;
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawStraight(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StraightVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StraightHorizontal, sectionData);
        }

        private static void DrawStartGrid(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StartGridVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StartGridHorizontal, sectionData);
        }

        private static void DrawFinish(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.FinishVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.FinishHorizontal, sectionData);
        }

        private static void Draw(string[] symbols, SectionData sectionData = null)
        {
            if (CVisualization._direction is Directions.East or Directions.West or Directions.South)
            {
                DrawDownwards(symbols, sectionData);
            }
            else
            {
                DrawUpwards(symbols, sectionData);
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
            }
        }

        private static void DrawDownwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorDownwards();
            }
        }

        private static void DrawUpwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorUpwards();
            }
        }

        private static string[] SectionDataToSymbols(string[] symbols, SectionData sectionData = null)
        {
            if (sectionData == null || (sectionData.Left == null &amp;&amp; sectionData.Right == null))
            {
                return symbols;
            }

            if (sectionData.Left != null &amp;&amp; sectionData.Right != null)
            {
                return CVisualization.PlaceBothParticipantsOnSection(symbols.ToArray(), sectionData.Left, sectionData.Right);
            }
            
            if (sectionData.Left != null || sectionData.Right != null)
            {
                return CVisualization.PlaceOneParticipantOnSection(symbols.ToArray(), sectionData.Left ?? sectionData.Right);
            }

            return symbols;
        }

        private static string[] PlaceBothParticipantsOnSection(string[] symbols, IParticipant participantOne, IParticipant participantTwo)
        {
            int indexOne = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex,
                indexTwo = CVisualization.InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex,
                initialsStartIndex = CVisualization.InitialsInGraphicsSymbolHorizontalStartIndex;
            string
                initialsStartOne = participantOne.GetInitials(CVisualization.MaxInitialsLength),
                initialsStartTwo = participantTwo.GetInitials(CVisualization.MaxInitialsLength),
                initialsOne = initialsStartOne,
                initialsTwo = initialsStartTwo;


            if (CVisualization.DirectionIsVertical())
            {
                indexOne = CVisualization.InitialsOnPositionOneInGraphicsSymbolsVerticalIndex;
                indexTwo = CVisualization.InitialsOnPositionTwoInGraphicsSymbolsVerticalIndex;
                initialsStartIndex = CVisualization.InitialsInGraphicsSymbolVerticalStartIndex;
                initialsOne = initialsStartOne.First().ToString() + initialsStartTwo.First().ToString();
                initialsTwo = initialsStartOne?.ElementAtOrDefault(1).ToString() +
                              initialsStartTwo?.ElementAtOrDefault(1).ToString();
            }

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbol(symbols[indexOne], initialsOne, initialsStartIndex);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbol(symbols[indexTwo], initialsTwo, initialsStartIndex);

            return symbols;
        }

        private static string[] PlaceOneParticipantOnSection(string[] symbols, IParticipant participant)
        {
            int indexOne = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex;

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbol(symbols[indexOne], participant.GetInitials(CVisualization.MaxInitialsLength));

            return symbols;
        }

        private static void MoveCursorUpwards()
        {
            CVisualization._cursorNorthPosition--;
        }

        private static void MoveCursorDownwards()
        {
            CVisualization._cursorNorthPosition++;
        }

        private static void WriteLine(string symbol)
        {
            Console.SetCursorPosition(CVisualization._cursorEastPosition, CVisualization._cursorNorthPosition);
            Console.WriteLine(symbol);
        }

        private static string MergeInitialsIntoSymbol(string symbol, string initials, int initialsStartIndex = CVisualization.InitialsInGraphicsSymbolHorizontalStartIndex)
        { 
            int maxInitialsLength = initials.Length &lt; CVisualization.MaxInitialsLength ? initials.Length : CVisualization.MaxInitialsLength;

            string trimmedInitials = initials.ToString();
            if (initials.Length &gt; CVisualization.MaxInitialsLength)
            {
                trimmedInitials = trimmedInitials.Remove(CVisualization.MaxInitialsLength);
            }

            return symbol.Remove(initialsStartIndex, maxInitialsLength).Insert(initialsStartIndex, trimmedInitials);
        }

        private static int CenteredTextCursorStartPosition(string text)
        {
            return (Console.WindowWidth / 2) - (text.Length / 2);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,78,0],[25,9,25,79,0],[51,9,52,62,0],[53,13,53,64,0],[55,9,56,58,0],[57,13,57,60,0],[61,9,62,64,0],[63,13,63,62,0],[65,13,65,67,0],[66,13,66,65,0],[68,13,68,66,0],[69,13,69,64,0],[71,13,71,66,0],[72,13,72,68,0],[74,13,74,68,0],[75,13,75,64,0],[77,13,77,65,0],[78,13,78,68,0],[80,13,80,65,0],[81,13,81,64,0],[85,9,85,10,0],[86,13,86,68,0],[87,9,87,10,0],[90,9,90,10,0],[91,13,91,54,0],[92,9,92,10,0],[95,9,95,10,0],[96,13,96,38,0],[98,13,98,57,0],[99,13,99,58,0],[100,13,100,29,0],[102,13,102,87,0],[103,13,103,43,0],[105,13,105,73,0],[106,13,106,14,0],[107,17,107,78,0],[108,13,108,14,0],[110,13,110,74,0],[111,13,111,14,0],[112,17,112,80,0],[113,13,113,14,0],[115,13,115,20,0],[115,22,115,42,0],[115,43,115,45,0],[115,46,115,60,0],[116,13,116,14,0],[117,17,117,98,0],[118,13,118,14,0],[119,9,119,10,0],[122,9,122,10,0],[123,13,123,41,0],[126,21,126,48,0],[127,21,127,27,0],[129,21,129,47,0],[130,21,130,27,0],[132,21,132,49,0],[133,21,133,27,0],[135,21,135,50,0],[136,21,136,27,0],[138,21,138,45,0],[139,21,139,27,0],[141,21,141,90,0],[143,9,143,10,0],[146,9,146,10,0],[147,13,147,86,0],[148,9,148,10,0],[151,9,151,10,0],[152,13,152,84,0],[153,9,153,10,0],[156,9,156,10,0],[157,13,157,62,0],[158,13,158,14,0],[159,17,159,77,0],[160,17,160,62,0],[161,13,161,14,0],[162,18,162,68,0],[163,13,163,14,0],[164,17,164,78,0],[165,17,165,61,0],[166,13,166,14,0],[167,18,167,67,0],[168,13,168,14,0],[169,17,169,77,0],[170,17,170,62,0],[171,13,171,14,0],[172,18,172,68,0],[173,13,173,14,0],[174,17,174,76,0],[175,17,175,61,0],[176,13,176,14,0],[178,13,178,47,0],[181,21,181,88,0],[182,21,182,87,0],[183,21,183,27,0],[185,21,185,62,0],[186,21,186,87,0],[187,21,187,27,0],[189,21,189,92,0],[190,21,190,27,0],[193,21,193,27,0],[195,9,195,10,0],[198,9,198,10,0],[199,13,199,62,0],[200,13,200,14,0],[201,17,201,78,0],[202,17,202,62,0],[203,13,203,14,0],[204,18,204,68,0],[205,13,205,14,0],[206,17,206,79,0],[207,17,207,61,0],[208,13,208,14,0],[209,18,209,67,0],[210,13,210,14,0],[211,17,211,78,0],[212,17,212,62,0],[213,13,213,14,0],[214,18,214,68,0],[215,13,215,14,0],[216,17,216,77,0],[217,17,217,61,0],[218,13,218,14,0],[220,13,220,47,0],[223,21,223,62,0],[224,21,224,87,0],[225,21,225,27,0],[227,21,227,88,0],[228,21,228,87,0],[229,21,229,27,0],[231,21,231,92,0],[232,21,232,27,0],[235,21,235,27,0],[237,9,237,10,0],[240,9,240,10,0],[241,13,241,54,0],[242,13,242,14,0],[243,17,243,83,0],[244,17,244,24,0],[247,13,247,81,0],[248,9,248,10,0],[251,9,251,10,0],[252,13,252,54,0],[253,13,253,14,0],[254,17,254,84,0],[255,17,255,24,0],[258,13,258,82,0],[259,9,259,10,0],[262,9,262,10,0],[263,13,263,54,0],[264,13,264,14,0],[265,17,265,81,0],[266,17,266,24,0],[269,13,269,79,0],[270,9,270,10,0],[273,9,273,10,0],[274,13,274,101,0],[275,13,275,14,0],[276,17,276,53,0],[277,13,277,14,0],[279,13,279,14,0],[280,17,280,51,0],[281,13,281,14,0],[283,13,283,47,0],[286,21,286,88,0],[287,21,287,87,0],[288,21,288,27,0],[290,21,290,88,0],[291,21,291,87,0],[292,21,292,27,0],[294,9,294,10,0],[297,9,297,10,0],[298,13,298,95,0],[300,13,300,20,0],[300,22,300,35,0],[300,36,300,38,0],[300,39,300,51,0],[301,13,301,14,0],[302,17,302,50,0],[303,17,303,54,0],[304,13,304,14,0],[305,9,305,10,0],[308,9,308,10,0],[309,13,309,95,0],[311,13,311,20,0],[311,22,311,35,0],[311,36,311,38,0],[311,39,311,51,0],[312,13,312,14,0],[313,17,313,50,0],[314,17,314,52,0],[315,13,315,14,0],[316,9,316,10,0],[319,9,319,10,0],[320,13,320,96,0],[321,13,321,14,0],[322,17,322,32,0],[325,13,325,71,0],[326,13,326,14,0],[327,17,327,126,0],[330,13,330,71,0],[331,13,331,14,0],[332,17,332,126,0],[335,13,335,28,0],[336,9,336,10,0],[339,9,339,10,0],[340,13,340,96,0],[341,17,341,96,0],[342,17,342,97,0],[343,13,344,96,0],[345,17,345,96,0],[346,17,346,47,0],[347,17,347,47,0],[350,13,350,54,0],[351,13,351,14,0],[352,17,352,95,0],[353,17,353,95,0],[354,17,354,96,0],[355,17,355,105,0],[356,17,357,82,0],[358,13,358,14,0],[360,13,360,124,0],[361,13,361,124,0],[363,13,363,28,0],[364,9,364,10,0],[367,9,367,10,0],[368,13,368,97,0],[370,13,370,150,0],[372,13,372,28,0],[373,9,373,10,0],[376,9,376,10,0],[377,13,377,50,0],[378,9,378,10,0],[381,9,381,10,0],[382,13,382,50,0],[383,9,383,10,0],[386,9,386,10,0],[387,13,387,51,0],[388,9,388,10,0],[391,9,391,10,0],[392,13,392,51,0],[393,9,393,10,0],[396,9,396,10,0],[397,13,397,112,0],[398,13,398,39,0],[399,9,399,10,0],[402,9,402,10,0],[403,13,403,141,0],[405,13,405,58,0],[406,13,406,68,0],[407,13,407,14,0],[408,17,408,92,0],[409,13,409,14,0],[411,13,411,117,0],[412,9,412,10,0],[415,9,415,10,0],[416,13,416,66,0],[417,9,417,10,0],[420,9,420,10,0],[421,13,421,39,0],[422,13,422,43,0],[423,13,423,39,0],[424,13,424,50,0],[425,13,425,40,0],[426,13,426,39,0],[427,9,427,10,0],[430,9,430,10,0],[431,13,431,29,0],[432,13,432,28,0],[433,13,433,31,0],[434,13,434,28,0],[435,13,435,30,0],[436,13,436,28,0],[437,13,437,26,0],[439,13,439,40,0],[441,13,441,42,0],[443,13,443,29,0],[444,13,444,28,0],[445,13,445,30,0],[446,13,446,28,0],[447,13,447,31,0],[448,13,448,28,0],[449,13,449,26,0],[450,9,450,10,0],[453,9,453,10,0],[454,13,454,57,0],[456,13,456,43,0],[457,13,457,44,0],[458,13,458,43,0],[459,13,459,41,0],[460,13,460,43,0],[462,13,462,45,0],[463,13,463,43,0],[464,13,464,41,0],[465,13,465,44,0],[467,13,467,45,0],[468,13,468,43,0],[469,13,469,44,0],[470,13,470,43,0],[471,13,471,41,0],[472,13,472,43,0],[473,13,473,43,0],[475,13,475,45,0],[476,13,476,43,0],[477,13,477,41,0],[478,13,478,44,0],[480,13,480,45,0],[481,13,481,43,0],[482,9,482,10,0],[485,9,485,10,0],[486,13,486,57,0],[488,13,488,43,0],[489,13,489,44,0],[490,13,490,43,0],[491,13,491,41,0],[492,13,492,43,0],[494,13,494,46,0],[495,13,495,43,0],[496,13,496,41,0],[497,13,497,44,0],[499,13,499,46,0],[500,13,500,43,0],[501,13,501,44,0],[502,13,502,43,0],[503,13,503,41,0],[504,13,504,43,0],[505,13,505,43,0],[507,13,507,46,0],[508,13,508,43,0],[509,13,509,41,0],[510,13,510,44,0],[512,13,512,46,0],[513,13,513,43,0],[514,9,514,10,0]]);
    </script>
  </body>
</html>