<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\Development\C#\RaceSimulator\Controller\Race.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Timers;
using Model;

namespace Controller
{

    public class Race
    {

        private const int
            StartDistanceOfParticipant = 0,
            TimerInterval = 500;
        
        public const int SectionLength = IEquipment.MaximumPerformance * IEquipment.MaximumSpeed;

        public Track Track { get; private set; }

        public List&lt;IParticipant&gt; Participants { get; private set; }

        public DateTime StartTime { get; private set; }

        private Random _random;

        // Only 2 participants per section are allowed.
        private Dictionary&lt;Section, SectionData&gt; _positions;

        private readonly Timer _timer;

        public static event EventHandler&lt;DriversChangedEventArgs&gt; DriversChanged;

        private static Race _raceReference;

        private static bool _changedDrivers;

        public Race(Track track, List&lt;IParticipant&gt; participants)
        {
            this.Track = track;
            this.Participants = participants;
            this._random = new Random(DateTime.Now.Millisecond);
            this._positions = new Dictionary&lt;Section, SectionData&gt;();
            this._timer = new Timer(Race.TimerInterval);
            this._timer.Elapsed += Race.OnTimedEvent;
            
            this.PlaceParticipantsOnStartPositions();
        }

        public void Start()
        {
            this.StartTime = DateTime.Now;
            this._timer.Enabled = true;
            Race._raceReference = this;
        }

        public static void OnTimedEvent(Object source, ElapsedEventArgs e)
        {
            Race._raceReference.MoveParticipants();
            if (!Race._changedDrivers)
            {
                return;
            }

            Race.DriversChanged?.Invoke(source, new DriversChangedEventArgs(Race._raceReference));
            Race._changedDrivers = false;
        }

        public SectionData GetSectionData(Section section)
        {
            if (!this._positions.Any() || !this._positions.TryGetValue(section, out var foundSectionData))
            {
                foundSectionData = new SectionData();
                this._positions.Add(section, foundSectionData);
            }

            return foundSectionData;
        }

        public bool UpdateSectionData(Section section, SectionData sectionData)
        {
            if (!this._positions.ContainsKey(section))
            {
                return false;
            }

            this._positions[section] = sectionData;
            Race._changedDrivers = true;
            return true;
        }

        private void MoveParticipants()
        {
            Section[] sections = this.Track.Sections.ToArray();
            foreach (Section section in sections)
            {
                SectionData sectionData = this.GetSectionData(section);
                if (sectionData.Left != null &amp;&amp; this.CanMoveParticipant(sectionData.DistanceLeft))
                {
                    sectionData.MoveLeft();
                }

                if (sectionData.Right != null &amp;&amp; this.CanMoveParticipant(sectionData.DistanceRight))
                {
                    sectionData.MoveRight();
                }
                
                this.UpdateSectionData(section, sectionData);
            }
            
            this.MoveParticipantsToNextSectionIfNecessary();
        }

        private void MoveParticipantsToNextSectionIfNecessary()
        {
            Section[] sections = this.Track.Sections.ToArray();
            for (int delta = 0; delta &lt; sections.Length; delta++)
            {
                int nextSectionDelta = (delta + 1) &gt;= sections.Length ? 0 : delta + 1;

                Section
                    section = sections[delta],
                    nextSection = sections[nextSectionDelta];
                SectionData
                    sectionData = this.GetSectionData(section),
                    nextSectionData = this.GetSectionData(nextSection);
                
                if (this.ShouldMoveParticipantsToNextSection(sectionData))
                {
                    nextSectionData = this.MoveParticipantsToNextSection(
                        sectionData, nextSection, nextSectionData, sectionData.Left, sectionData.Right
                    );
                    
                    this.UpdateSectionData(nextSection, nextSectionData);
                    this.UpdateSectionData(section, sectionData);
                }
                else if (this.ShouldMoveParticipantToNextSection(sectionData))
                {
                    IParticipant participant = this.GetParticipantWhoShouldMoveToNextSection(sectionData);
                
                    nextSectionData = this.MoveParticipantToNextSection(
                        sectionData, nextSection, nextSectionData, participant
                    );
                    
                    this.UpdateSectionData(nextSection, nextSectionData);
                    this.UpdateSectionData(section, sectionData);
                }
            }
        }

        private bool CanMoveParticipant(int distance)
        {
            return distance &lt; Race.SectionLength;
        }
        
        private bool ShouldMoveParticipantToNextSection(SectionData sectionData)
        {
            return (sectionData.DistanceLeft &gt;= Race.SectionLength &amp;&amp; sectionData.Left != null) 
                   || (sectionData.DistanceRight &gt;= Race.SectionLength &amp;&amp; sectionData.Right != null);
        }

        private bool ShouldMoveParticipantsToNextSection(SectionData sectionData)
        {
            return sectionData.DistanceLeft &gt;= Race.SectionLength &amp;&amp; sectionData.Left != null
                   &amp;&amp; sectionData.DistanceRight &gt;= Race.SectionLength &amp;&amp; sectionData.Right != null;
        }

        private IParticipant GetParticipantWhoShouldMoveToNextSection(SectionData sectionData)
        {
            if (!this.ShouldMoveParticipantToNextSection(sectionData))
            {
                return null;
            }

            return sectionData.DistanceLeft &gt;= Race.SectionLength ? sectionData.Left : sectionData.Right;
        }

        private SectionData MoveParticipantToNextSection(SectionData sectionData, Section nextSection, SectionData nextSectionData, IParticipant participant)
        {
            if (!this.CanPlaceParticipant(nextSectionData, participant))
            {
                return nextSectionData;
            }
            
            nextSectionData = this.ParticipantToSectionData(nextSection, nextSectionData, participant);
            sectionData.Clear(participant);

            return nextSectionData;
        }

        private SectionData MoveParticipantsToNextSection(SectionData sectionData, Section nextSection, SectionData nextSectionData, IParticipant participantLeft, IParticipant participantRight)
        {
            if (!this.CanPlaceParticipants(nextSectionData, participantLeft, participantRight))
            {
                return nextSectionData;
            }
            
            nextSectionData = this.ParticipantsToSectionData(nextSection, nextSectionData, participantLeft, participantRight);
            sectionData.Clear(participantLeft, participantRight);

            return nextSectionData;
        }

        private void PlaceParticipantsOnStartPositions()
        {
            List&lt;IParticipant&gt; participants = this.Participants.ToList();
            Section[] sections = this.Track.Sections.ToArray();

            for (int delta = 0; delta &lt; sections.Length; delta++)
            {
                Section section = sections[delta];
                SectionData sectionData = this.GetSectionData(section);

                if (!this.CanPlaceParticipantsOnStartPosition(section.SectionType))
                {
                    continue;
                }

                IParticipant participantOne = participants.ElementAtOrDefault(0);
                IParticipant participantTwo = participants.ElementAtOrDefault(1);
                bool 
                    canPlaceBoth = this.CanPlaceParticipants(sectionData, participantOne, participantTwo),
                    canPlaceOne = this.CanPlaceParticipant(sectionData, participantOne);

                if (!canPlaceBoth &amp;&amp; canPlaceOne)
                {
                    sectionData = this.ParticipantToSectionData(section, sectionData, participantOne);
                    participants.RemoveAt(0);
                }
                else if (canPlaceBoth)
                {
                    sectionData = this.ParticipantsToSectionData(section, sectionData, participantOne, participantTwo);
                    participants.RemoveAt(0);
                    participants.RemoveAt(0);
                }

                this.UpdateSectionData(section, sectionData);
            }
        }

        private bool CanPlaceParticipantsOnStartPosition(SectionTypes sectionType)
        {
            return sectionType == SectionTypes.StartGrid;
        }

        private bool CanPlaceParticipants(SectionData sectionData, IParticipant leftParticipant, IParticipant rightParticipant)
        {
            if (leftParticipant == null || rightParticipant == null)
            {
                return false;
            }

            return sectionData.Left == null &amp;&amp; sectionData.Right == null;
        }

        private bool CanPlaceParticipant(SectionData sectionData, IParticipant participant)
        {
            if (participant == null)
            {
                return false;
            }

            return this.CanPlaceLeftParticipant(sectionData) || this.CanPlaceRightParticipant(sectionData);
        }

        private bool CanPlaceLeftParticipant(SectionData sectionData)
        {
            return sectionData.Left == null &amp;&amp; (sectionData.Right != null || sectionData.Right == null);
        }

        private bool CanPlaceRightParticipant(SectionData sectionData)
        {
            return sectionData.Right == null &amp;&amp; (sectionData.Left != null || sectionData.Left == null);
        }

        private SectionData ParticipantsToSectionData(Section section, SectionData sectionData, IParticipant leftParticipant, IParticipant rightParticipant)
        {
            if (!this.CanPlaceParticipants(sectionData, leftParticipant, rightParticipant))
            {
                return null;
            }

            int defaultDistance = Race.StartDistanceOfParticipant;

            return new SectionData(section, leftParticipant, defaultDistance, rightParticipant, defaultDistance);
        }

        private SectionData ParticipantToSectionData(Section section, SectionData sectionData, IParticipant participant)
        {
            int defaultDistance = Race.StartDistanceOfParticipant;

            if (this.CanPlaceLeftParticipant(sectionData))
            {
                return new SectionData(section, participant, defaultDistance, sectionData.Right, defaultDistance);
            }

            if (this.CanPlaceRightParticipant(sectionData))
            {
                return new SectionData(section, sectionData.Left, defaultDistance, participant, defaultDistance);
            }

            return null;
        }

        private void RandomizeEquipment()
        {
            foreach (IParticipant participant in this.Participants)
            {
                IEquipment equipment = participant.Equipment;
                equipment.SetRandomPerformance();
                equipment.SetRandomQuality();
            }
        }

        public static int ConvertRange(int originalStart, int originalEnd, int newStart, int newEnd, int value)
        {
            double scale = (double)(newEnd - newStart) / (originalEnd - originalStart);
            
            return (int)(newStart + ((value - originalStart) * scale));
        }
        
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,30,21,34,1],[21,35,21,47,1],[23,50,23,54,1],[23,55,23,67,1],[25,37,25,41,1],[25,42,25,54,1],[40,9,40,66,1],[41,9,41,10,1],[42,13,42,32,1],[43,13,43,46,1],[44,13,44,65,1],[45,13,45,70,1],[46,13,46,57,1],[47,13,47,54,1],[49,13,49,54,1],[50,9,50,10,1],[53,9,53,10,1],[54,13,54,43,1],[55,13,55,40,1],[56,13,56,40,1],[57,9,57,10,1],[60,9,60,10,1],[61,13,61,52,1],[62,13,62,39,1],[63,13,63,14,0],[64,17,64,24,0],[67,13,67,99,1],[68,13,68,42,1],[69,9,69,10,1],[72,9,72,10,1],[73,13,73,107,1],[74,13,74,14,1],[75,17,75,54,1],[76,17,76,64,1],[77,13,77,14,1],[79,13,79,37,1],[80,9,80,10,1],[83,9,83,10,1],[84,13,84,55,1],[85,13,85,14,1],[86,17,86,30,1],[89,13,89,52,1],[90,13,90,41,1],[91,13,91,25,1],[92,9,92,10,1],[95,9,95,10,1],[96,13,96,64,1],[97,13,97,20,1],[97,22,97,37,1],[97,38,97,40,1],[97,41,97,49,1],[98,13,98,14,1],[99,17,99,72,1],[100,17,100,99,1],[101,17,101,18,1],[102,21,102,44,1],[103,17,103,18,1],[105,17,105,101,1],[106,17,106,18,1],[107,21,107,45,1],[108,17,108,18,1],[110,17,110,62,1],[111,13,111,14,1],[113,13,113,61,1],[114,9,114,10,1],[117,9,117,10,1],[118,13,118,64,1],[119,18,119,31,1],[119,33,119,56,1],[119,58,119,65,1],[120,13,120,14,1],[121,17,121,87,1],[123,17,124,46,1],[125,21,125,61,1],[126,17,127,63,1],[128,21,128,71,1],[130,17,130,75,1],[131,17,131,18,1],[132,21,134,23,1],[136,21,136,74,1],[137,21,137,66,1],[138,17,138,18,1],[139,22,139,79,1],[140,17,140,18,1],[141,21,141,107,1],[143,21,145,23,1],[147,21,147,74,1],[148,21,148,66,1],[149,17,149,18,1],[150,13,150,14,1],[151,9,151,10,1],[154,9,154,10,1],[155,13,155,50,1],[156,9,156,10,1],[159,9,159,10,1],[160,13,161,102,1],[162,9,162,10,1],[165,9,165,10,1],[166,13,167,100,1],[168,9,168,10,1],[171,9,171,10,1],[172,13,172,71,1],[173,13,173,14,0],[174,17,174,29,0],[177,13,177,106,1],[178,9,178,10,1],[181,9,181,10,1],[182,13,182,73,1],[183,13,183,14,0],[184,17,184,40,0],[187,13,187,104,1],[188,13,188,44,1],[190,13,190,36,1],[191,9,191,10,1],[194,9,194,10,1],[195,13,195,96,1],[196,13,196,14,0],[197,17,197,40,0],[200,13,200,127,1],[201,13,201,66,1],[203,13,203,36,1],[204,9,204,10,1],[207,9,207,10,1],[208,13,208,74,1],[209,13,209,64,1],[211,18,211,31,1],[211,33,211,56,1],[211,58,211,65,1],[212,13,212,14,1],[213,17,213,51,1],[214,17,214,72,1],[216,17,216,84,1],[217,17,217,18,1],[218,21,218,30,1],[221,17,221,82,1],[222,17,222,82,1],[223,17,224,106,1],[225,21,225,88,1],[227,17,227,50,1],[228,17,228,18,1],[229,21,229,103,1],[230,21,230,46,1],[231,17,231,18,1],[232,22,232,39,1],[233,17,233,18,1],[234,21,234,120,1],[235,21,235,46,1],[236,21,236,46,1],[237,17,237,18,1],[239,17,239,62,1],[240,13,240,14,1],[241,9,241,10,1],[244,9,244,10,1],[245,13,245,58,1],[246,9,246,10,1],[249,9,249,10,1],[250,13,250,69,1],[251,13,251,14,1],[252,17,252,30,1],[255,13,255,74,1],[256,9,256,10,1],[259,9,259,10,1],[260,13,260,37,1],[261,13,261,14,1],[262,17,262,30,1],[265,13,265,108,1],[266,9,266,10,1],[269,9,269,10,1],[270,13,270,105,1],[271,9,271,10,1],[274,9,274,10,0],[275,13,275,104,0],[276,9,276,10,0],[279,9,279,10,1],[280,13,280,92,1],[281,13,281,14,0],[282,17,282,29,0],[285,13,285,67,1],[287,13,287,114,1],[288,9,288,10,1],[291,9,291,10,1],[292,13,292,67,1],[294,13,294,59,1],[295,13,295,14,1],[296,17,296,115,1],[299,13,299,60,0],[300,13,300,14,0],[301,17,301,114,0],[304,13,304,25,0],[305,9,305,10,1],[308,9,308,10,0],[309,13,309,20,0],[309,22,309,46,0],[309,47,309,49,0],[309,50,309,67,0],[310,13,310,14,0],[311,17,311,62,0],[312,17,312,50,0],[313,17,313,46,0],[314,13,314,14,0],[315,9,315,10,0],[318,9,318,10,1],[319,13,319,88,1],[321,13,321,72,1],[322,9,322,10,1]]);
    </script>
  </body>
</html>