<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\Development\C#\RaceSimulator\RaceSimulator\CVisualization.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Controller;
using Model;

namespace RaceSimulator
{
    internal enum Directions
    {
        North = 0,
        East = 1,
        South = 2,
        West = 3
    }

    public static class CVisualization
    {

        private static readonly Directions _startDirection = Directions.East;
        private static Directions _direction = CVisualization._startDirection;

        private const int
            SymbolSpaces = 4,

            /*
             * The first property determines the max length of the initials and trims the initials
             * to the selected length. The second property determines the index of the initials
             * inside a string of the graphics strings.
             *
             * If we have the string: &quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot; for example, the initials
             * will be placed on the selected position. The third and fourth property determines
             * which string of the symbols we have to take. 
             *
             * If the value of the first property is 0, and of the second 1 and of the third 2,
             * the output will be this: &quot;----&quot;, &quot;AB| &quot;, &quot;CD| &quot;, &quot;----&quot; or &quot;----&quot;, &quot;A | &quot;, &quot;BC| &quot;, &quot;----&quot;
             * or &quot;----&quot;, &quot;AB| &quot;, &quot;  | &quot;, &quot;----&quot;.
             */
            MaxInitialsLength = 1,
            InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex = 1,
            InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex = 2,
            InitialsOnPositionOneInGraphicsSymbolsVerticalIndex = 2,
            InitialsOnPositionTwoInGraphicsSymbolsVerticalIndex = 3;

        private static readonly int
            CursorStartEastPosition = Console.WindowWidth / 2, 
            CursorStartNorthPosition = Console.WindowHeight / 2;

        private static int
            _cursorEastPosition = CursorStartEastPosition,
            _cursorNorthPosition = CursorStartNorthPosition;

        #region graphics

        private static readonly string[]
            FinishHorizontal = {&quot;----&quot;, &quot;  # &quot;, &quot;  # &quot;, &quot;----&quot;},
            FinishVertical = {&quot;|  |&quot;, &quot;|##|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StartGridHorizontal = {&quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot;},
            StartGridVertical = {&quot;|  |&quot;, &quot;|--|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StraightHorizontal = {&quot;----&quot;, &quot;    &quot;, &quot;    &quot;, &quot;----&quot;},
            StraightVertical = {&quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            NorthCornerToRight = {&quot;|  /&quot;, &quot;|   &quot;, &quot;/   &quot;, &quot; /--&quot;},
            NorthCornerToLeft = {&quot;\\  |&quot;, &quot;   |&quot;, &quot;   \\&quot;, &quot;--\\ &quot;},

            EastCornerToRight = {&quot;--\\ &quot;, &quot;   \\&quot;, &quot;   |&quot;, &quot;\\  |&quot;},
            EastCornerToLeft = {&quot;/  |&quot;, &quot;   |&quot;, &quot;   /&quot;, &quot;--/ &quot;},

            SouthCornerToRight = CVisualization.EastCornerToLeft,
            SouthCornerToLeft = {&quot;|  \\&quot;, &quot;|   &quot;, &quot;\\   &quot;, &quot; \\--&quot;},

            WestCornerToRight = CVisualization.SouthCornerToLeft,
            WestCornerToLeft = {&quot; /--&quot;, &quot;/   &quot;, &quot;|   &quot;, &quot;|  /&quot;};
        #endregion

        public static void Initialize()
        {
            Race.DriversChanged += CVisualization.OnDriversChanged;
        }

        public static void OnDriversChanged(object sender, DriversChangedEventArgs eventArgs)
        {
            CVisualization.DrawTrack(eventArgs.Race);
        }

        public static void DrawTrack(Race race)
        {
            Track track = race.Track;

            Console.BackgroundColor = ConsoleColor.Blue;
            Console.ForegroundColor = ConsoleColor.White;
            Console.Clear();

            Console.SetCursorPosition(CenteredTextCursorStartPosition(track.Name), 1);
            Console.WriteLine(track.Name);

            CVisualization._cursorEastPosition = CVisualization.CursorStartEastPosition;
            if (track.EastStartPosition != Track.StartPositionUndefined)
            {
                CVisualization._cursorEastPosition = track.EastStartPosition;
            }

            CVisualization._cursorNorthPosition = CVisualization.CursorStartNorthPosition;
            if (track.NorthStartPosition != Track.StartPositionUndefined)
            {
                CVisualization._cursorNorthPosition = track.NorthStartPosition;
            }

            foreach (Section trackSection in track.Sections)
            {
                CVisualization.DrawTrackSection(trackSection, race.GetSectionData(trackSection));
            }
        }

        private static void DrawTrackSection(Section section, SectionData sectionData)
        {
            switch (section.SectionType)
            {
                case SectionTypes.StartGrid:
                    DrawStartGrid(sectionData);
                    break;
                case SectionTypes.Straight:
                    DrawStraight(sectionData);
                    break;
                case SectionTypes.LeftCorner:
                    DrawLeftCorner(sectionData);
                    break;
                case SectionTypes.RightCorner:
                    DrawRightCorner(sectionData);
                    break;
                case SectionTypes.Finish:
                    DrawFinish(sectionData);
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;Unknown section type given!&quot;);
            }
        }

        private static bool DirectionIsVertical()
        {
            return CVisualization._direction is Directions.South or Directions.North;
        }

        private static void DrawLeftCorner(SectionData sectionData = null)
        {
            if (CVisualization._direction == Directions.East)
            {
                DrawDownwards(CVisualization.EastCornerToLeft, sectionData);
                CVisualization._direction = Directions.North;
            }
            else if (CVisualization._direction == Directions.South)
            {
                DrawDownwards(CVisualization.SouthCornerToLeft, sectionData);
                CVisualization._direction = Directions.East;
            }
            else if (CVisualization._direction == Directions.West)
            {
                DrawDownwards(CVisualization.WestCornerToLeft, sectionData);
                CVisualization._direction = Directions.South;
            }
            else if (CVisualization._direction == Directions.North)
            {
                DrawUpwards(CVisualization.NorthCornerToLeft, sectionData);
                CVisualization._direction = Directions.West;
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawRightCorner(SectionData sectionData = null)
        {
            if (CVisualization._direction == Directions.East)
            {
                DrawDownwards(CVisualization.EastCornerToRight, sectionData);
                CVisualization._direction = Directions.South;
            }
            else if (CVisualization._direction == Directions.South)
            {
                DrawDownwards(CVisualization.SouthCornerToRight, sectionData);
                CVisualization._direction = Directions.West;
            }
            else if (CVisualization._direction == Directions.West)
            {
                DrawDownwards(CVisualization.WestCornerToRight, sectionData);
                CVisualization._direction = Directions.North;
            }
            else if (CVisualization._direction == Directions.North)
            {
                DrawUpwards(CVisualization.NorthCornerToRight, sectionData);
                CVisualization._direction = Directions.East;
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawStraight(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StraightVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StraightHorizontal, sectionData);
        }

        private static void DrawStartGrid(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StartGridVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StartGridHorizontal, sectionData);
        }

        private static void DrawFinish(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.FinishVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.FinishHorizontal, sectionData);
        }

        private static void Draw(string[] symbols, SectionData sectionData = null)
        {
            if (CVisualization._direction is Directions.East or Directions.West or Directions.South)
            {
                DrawDownwards(symbols, sectionData);
            }
            else
            {
                DrawUpwards(symbols, sectionData);
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
            }
        }

        private static void DrawDownwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorDownwards();
            }
        }

        private static void DrawUpwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorUpwards();
            }
        }

        private static string[] SectionDataToSymbols(string[] symbols, SectionData sectionData = null)
        {
            if (sectionData == null || (sectionData.Left == null &amp;&amp; sectionData.Right == null))
            {
                return symbols;
            }

            if (sectionData.Left != null &amp;&amp; sectionData.Right != null)
            {
                return CVisualization.PlaceBothParticipantsOnSection(
                    symbols.ToArray(), 
                    sectionData.Left, sectionData.DistanceLeft, 
                    sectionData.Right, sectionData.DistanceRight
                    );
            }
            
            if (sectionData.Left != null || sectionData.Right != null)
            {
                return CVisualization.PlaceOneParticipantOnSection(
                    symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                    sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight
                    );
            }

            return symbols;
        }

        private static string[] PlaceBothParticipantsOnSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            int indexOne = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex,
                indexTwo = CVisualization.InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex;
            string
                initialsStartOne = participantOne.GetInitials(CVisualization.MaxInitialsLength),
                initialsStartTwo = participantTwo.GetInitials(CVisualization.MaxInitialsLength),
                initialsOne = initialsStartOne,
                initialsTwo = initialsStartTwo;


            if (CVisualization.DirectionIsVertical())
            {
                indexOne = CVisualization.InitialsOnPositionOneInGraphicsSymbolsVerticalIndex;
                indexTwo = CVisualization.InitialsOnPositionTwoInGraphicsSymbolsVerticalIndex;
                initialsOne = initialsStartOne.First().ToString() + initialsStartTwo.First().ToString();
                initialsTwo = initialsStartOne?.ElementAtOrDefault(1).ToString() +
                              initialsStartTwo?.ElementAtOrDefault(1).ToString();
            }

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbol(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbol(symbols[indexTwo], initialsTwo, distanceTwo);

            return symbols;
        }

        private static string[] PlaceOneParticipantOnSection(string[] symbols, IParticipant participant, int distance)
        {
            int indexOne = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex;

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbol(
                symbols[indexOne], participant.GetInitials(CVisualization.MaxInitialsLength), distance
            );

            return symbols;
        }

        private static void MoveCursorUpwards()
        {
            CVisualization._cursorNorthPosition--;
        }

        private static void MoveCursorDownwards()
        {
            CVisualization._cursorNorthPosition++;
        }

        private static void WriteLine(string symbol)
        {
            Console.SetCursorPosition(CVisualization._cursorEastPosition, CVisualization._cursorNorthPosition);
            Console.WriteLine(symbol);
        }

        private static string MergeInitialsIntoSymbol(string symbol, string initials, int distance)
        { 
            int maxInitialsLength = initials.Length &lt; CVisualization.MaxInitialsLength ? initials.Length : CVisualization.MaxInitialsLength;
            int initialsStartIndex = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);

            string trimmedInitials = initials.ToString();
            if (initials.Length &gt; CVisualization.MaxInitialsLength)
            {
                trimmedInitials = trimmedInitials.Remove(CVisualization.MaxInitialsLength);
            }

            if ((trimmedInitials.Length + initialsStartIndex) &gt; symbol.Length)
            {
                return symbol;
            }

            return symbol.Remove(initialsStartIndex, maxInitialsLength).Insert(initialsStartIndex, trimmedInitials);
        }

        private static int CenteredTextCursorStartPosition(string text)
        {
            return (Console.WindowWidth / 2) - (text.Length / 2);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,78,0],[25,9,25,79,0],[49,9,50,62,0],[51,13,51,64,0],[53,9,54,58,0],[55,13,55,60,0],[59,9,60,64,0],[61,13,61,62,0],[63,13,63,67,0],[64,13,64,65,0],[66,13,66,66,0],[67,13,67,64,0],[69,13,69,66,0],[70,13,70,68,0],[72,13,72,68,0],[73,13,73,64,0],[75,13,75,65,0],[76,13,76,68,0],[78,13,78,65,0],[79,13,79,64,0],[83,9,83,10,0],[84,13,84,68,0],[85,9,85,10,0],[88,9,88,10,0],[89,13,89,54,0],[90,9,90,10,0],[93,9,93,10,0],[94,13,94,38,0],[96,13,96,57,0],[97,13,97,58,0],[98,13,98,29,0],[100,13,100,87,0],[101,13,101,43,0],[103,13,103,89,0],[104,13,104,73,0],[105,13,105,14,0],[106,17,106,78,0],[107,13,107,14,0],[109,13,109,91,0],[110,13,110,74,0],[111,13,111,14,0],[112,17,112,80,0],[113,13,113,14,0],[115,13,115,20,0],[115,22,115,42,0],[115,43,115,45,0],[115,46,115,60,0],[116,13,116,14,0],[117,17,117,98,0],[118,13,118,14,0],[119,9,119,10,0],[122,9,122,10,0],[123,13,123,41,0],[126,21,126,48,0],[127,21,127,27,0],[129,21,129,47,0],[130,21,130,27,0],[132,21,132,49,0],[133,21,133,27,0],[135,21,135,50,0],[136,21,136,27,0],[138,21,138,45,0],[139,21,139,27,0],[141,21,141,90,0],[143,9,143,10,0],[146,9,146,10,0],[147,13,147,86,0],[148,9,148,10,0],[151,9,151,10,0],[152,13,152,62,0],[153,13,153,14,0],[154,17,154,77,0],[155,17,155,62,0],[156,13,156,14,0],[157,18,157,68,0],[158,13,158,14,0],[159,17,159,78,0],[160,17,160,61,0],[161,13,161,14,0],[162,18,162,67,0],[163,13,163,14,0],[164,17,164,77,0],[165,17,165,62,0],[166,13,166,14,0],[167,18,167,68,0],[168,13,168,14,0],[169,17,169,76,0],[170,17,170,61,0],[171,13,171,14,0],[173,13,173,47,0],[176,21,176,88,0],[177,21,177,87,0],[178,21,178,27,0],[180,21,180,62,0],[181,21,181,87,0],[182,21,182,27,0],[184,21,184,92,0],[185,21,185,27,0],[188,21,188,27,0],[190,9,190,10,0],[193,9,193,10,0],[194,13,194,62,0],[195,13,195,14,0],[196,17,196,78,0],[197,17,197,62,0],[198,13,198,14,0],[199,18,199,68,0],[200,13,200,14,0],[201,17,201,79,0],[202,17,202,61,0],[203,13,203,14,0],[204,18,204,67,0],[205,13,205,14,0],[206,17,206,78,0],[207,17,207,62,0],[208,13,208,14,0],[209,18,209,68,0],[210,13,210,14,0],[211,17,211,77,0],[212,17,212,61,0],[213,13,213,14,0],[215,13,215,47,0],[218,21,218,62,0],[219,21,219,87,0],[220,21,220,27,0],[222,21,222,88,0],[223,21,223,87,0],[224,21,224,27,0],[226,21,226,92,0],[227,21,227,27,0],[230,21,230,27,0],[232,9,232,10,0],[235,9,235,10,0],[236,13,236,54,0],[237,13,237,14,0],[238,17,238,83,0],[239,17,239,24,0],[242,13,242,81,0],[243,9,243,10,0],[246,9,246,10,0],[247,13,247,54,0],[248,13,248,14,0],[249,17,249,84,0],[250,17,250,24,0],[253,13,253,82,0],[254,9,254,10,0],[257,9,257,10,0],[258,13,258,54,0],[259,13,259,14,0],[260,17,260,81,0],[261,17,261,24,0],[264,13,264,79,0],[265,9,265,10,0],[268,9,268,10,0],[269,13,269,101,0],[270,13,270,14,0],[271,17,271,53,0],[272,13,272,14,0],[274,13,274,14,0],[275,17,275,51,0],[276,13,276,14,0],[278,13,278,47,0],[281,21,281,88,0],[282,21,282,87,0],[283,21,283,27,0],[285,21,285,88,0],[286,21,286,87,0],[287,21,287,27,0],[289,9,289,10,0],[292,9,292,10,0],[293,13,293,95,0],[295,13,295,20,0],[295,22,295,35,0],[295,36,295,38,0],[295,39,295,51,0],[296,13,296,14,0],[297,17,297,50,0],[298,17,298,54,0],[299,13,299,14,0],[300,9,300,10,0],[303,9,303,10,0],[304,13,304,95,0],[306,13,306,20,0],[306,22,306,35,0],[306,36,306,38,0],[306,39,306,51,0],[307,13,307,14,0],[308,17,308,50,0],[309,17,309,52,0],[310,13,310,14,0],[311,9,311,10,0],[314,9,314,10,0],[315,13,315,96,0],[316,13,316,14,0],[317,17,317,32,0],[320,13,320,71,0],[321,13,321,14,0],[322,17,326,23,0],[329,13,329,71,0],[330,13,330,14,0],[331,17,334,23,0],[337,13,337,28,0],[338,9,338,10,0],[341,9,341,10,0],[342,13,342,96,0],[343,17,343,96,0],[344,13,345,96,0],[346,17,346,96,0],[347,17,347,47,0],[348,17,348,47,0],[351,13,351,54,0],[352,13,352,14,0],[353,17,353,95,0],[354,17,354,95,0],[355,17,355,105,0],[356,17,357,82,0],[358,13,358,14,0],[360,13,360,117,0],[361,13,361,117,0],[363,13,363,28,0],[364,9,364,10,0],[367,9,367,10,0],[368,13,368,97,0],[370,13,372,15,0],[374,13,374,28,0],[375,9,375,10,0],[378,9,378,10,0],[379,13,379,51,0],[380,9,380,10,0],[383,9,383,10,0],[384,13,384,51,0],[385,9,385,10,0],[388,9,388,10,0],[389,13,389,112,0],[390,13,390,39,0],[391,9,391,10,0],[394,9,394,10,0],[395,13,395,141,0],[396,13,396,121,0],[398,13,398,58,0],[399,13,399,68,0],[400,13,400,14,0],[401,17,401,92,0],[402,13,402,14,0],[404,13,404,79,0],[405,13,405,14,0],[406,17,406,31,0],[409,13,409,117,0],[410,9,410,10,0],[413,9,413,10,0],[414,13,414,66,0],[415,9,415,10,0]]);
    </script>
  </body>
</html>