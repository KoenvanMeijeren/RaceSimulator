<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\Development\C#\RaceSimulator\RaceSimulator\CVisualization.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Controller;
using Model;

namespace RaceSimulator
{
    internal enum Directions
    {
        North = 0,
        East = 1,
        South = 2,
        West = 3
    }

    public static class CVisualization
    {

        private static readonly Directions _startDirection = Directions.East;
        private static Directions _direction = CVisualization._startDirection;

        private const int
            SymbolSpaces = 4,

            /*
             * The first property determines the max length of the initials and trims the initials
             * to the selected length. The second property determines the index of the initials
             * inside a string of the graphics strings.
             *
             * If we have the string: &quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot; for example, the initials
             * will be placed on the selected position. The third and fourth property determines
             * which string of the symbols we have to take. 
             *
             * If the value of the first property is 0, and of the second 1 and of the third 2,
             * the output will be this: &quot;----&quot;, &quot;AB| &quot;, &quot;CD| &quot;, &quot;----&quot; or &quot;----&quot;, &quot;A | &quot;, &quot;BC| &quot;, &quot;----&quot;
             * or &quot;----&quot;, &quot;AB| &quot;, &quot;  | &quot;, &quot;----&quot;.
             */
            MaxInitialsLength = 1,
            InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex = 1,
            InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex = 2;

        private static readonly int
            CursorStartEastPosition = Console.WindowWidth / 2, 
            CursorStartNorthPosition = Console.WindowHeight / 2;

        private static int
            _cursorEastPosition = CursorStartEastPosition,
            _cursorNorthPosition = CursorStartNorthPosition;

        #region graphics

        private static readonly string[]
            FinishHorizontal = {&quot;----&quot;, &quot;  # &quot;, &quot;  # &quot;, &quot;----&quot;},
            FinishVertical = {&quot;|  |&quot;, &quot;|##|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StartGridHorizontal = {&quot;----&quot;, &quot;  | &quot;, &quot;  | &quot;, &quot;----&quot;},
            StartGridVertical = {&quot;|  |&quot;, &quot;|--|&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            StraightHorizontal = {&quot;----&quot;, &quot;    &quot;, &quot;    &quot;, &quot;----&quot;},
            StraightVertical = {&quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;, &quot;|  |&quot;},

            NorthCornerToRight = {&quot;|  /&quot;, &quot;|   &quot;, &quot;/   &quot;, &quot; /--&quot;},
            NorthCornerToLeft = {&quot;\\  |&quot;, &quot;   |&quot;, &quot;   \\&quot;, &quot;--\\ &quot;},

            EastCornerToRight = {&quot;--\\ &quot;, &quot;   \\&quot;, &quot;   |&quot;, &quot;\\  |&quot;},
            EastCornerToLeft = {&quot;/  |&quot;, &quot;   |&quot;, &quot;   /&quot;, &quot;--/ &quot;},

            SouthCornerToRight = CVisualization.EastCornerToLeft,
            SouthCornerToLeft = {&quot;|  \\&quot;, &quot;|   &quot;, &quot;\\   &quot;, &quot; \\--&quot;},

            WestCornerToRight = CVisualization.SouthCornerToLeft,
            WestCornerToLeft = {&quot; /--&quot;, &quot;/   &quot;, &quot;|   &quot;, &quot;|  /&quot;};
        #endregion

        public static void Initialize()
        {
            Race.DriversChanged += CVisualization.OnDriversChanged;
        }

        private static void OnDriversChanged(object sender, DriversChangedEventArgs eventArgs)
        {
            CVisualization.DrawTrack(eventArgs.Race);
        }

        public static void DrawTrack(Race race)
        {
            Track track = race.Track;

            Console.BackgroundColor = ConsoleColor.Blue;
            Console.ForegroundColor = ConsoleColor.White;
            Console.Clear();

            Console.SetCursorPosition(CenteredTextCursorStartPosition(track.Name), 1);
            Console.WriteLine(track.Name);

            CVisualization._direction = CVisualization._startDirection;
            CVisualization._cursorEastPosition = CVisualization.CursorStartEastPosition;
            if (track.EastStartPosition != Track.StartPositionUndefined)
            {
                CVisualization._cursorEastPosition = track.EastStartPosition;
            }

            CVisualization._cursorNorthPosition = CVisualization.CursorStartNorthPosition;
            if (track.NorthStartPosition != Track.StartPositionUndefined)
            {
                CVisualization._cursorNorthPosition = track.NorthStartPosition;
            }

            foreach (Section trackSection in track.Sections)
            {
                CVisualization.DrawTrackSection(trackSection, race.GetSectionData(trackSection));
            }
        }

        private static void DrawTrackSection(Section section, SectionData sectionData)
        {
            switch (section.SectionType)
            {
                case SectionTypes.StartGrid:
                    DrawStartGrid(sectionData);
                    break;
                case SectionTypes.Straight:
                    DrawStraight(sectionData);
                    break;
                case SectionTypes.LeftCorner:
                    DrawLeftCorner(sectionData);
                    break;
                case SectionTypes.RightCorner:
                    DrawRightCorner(sectionData);
                    break;
                case SectionTypes.Finish:
                    DrawFinish(sectionData);
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;Unknown section type given!&quot;);
            }
        }

        private static bool DirectionIsVertical()
        {
            return CVisualization._direction is Directions.South or Directions.North;
        }

        private static void DrawLeftCorner(SectionData sectionData = null)
        {
            if (CVisualization._direction == Directions.East)
            {
                DrawDownwards(CVisualization.EastCornerToLeft, sectionData);
                CVisualization._direction = Directions.North;
            }
            else if (CVisualization._direction == Directions.South)
            {
                DrawDownwards(CVisualization.SouthCornerToLeft, sectionData);
                CVisualization._direction = Directions.East;
            }
            else if (CVisualization._direction == Directions.West)
            {
                DrawDownwards(CVisualization.WestCornerToLeft, sectionData);
                CVisualization._direction = Directions.South;
            }
            else if (CVisualization._direction == Directions.North)
            {
                DrawUpwards(CVisualization.NorthCornerToLeft, sectionData);
                CVisualization._direction = Directions.West;
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawRightCorner(SectionData sectionData = null)
        {
            if (CVisualization._direction == Directions.East)
            {
                DrawDownwards(CVisualization.EastCornerToRight, sectionData);
                CVisualization._direction = Directions.South;
            }
            else if (CVisualization._direction == Directions.South)
            {
                DrawDownwards(CVisualization.SouthCornerToRight, sectionData);
                CVisualization._direction = Directions.West;
            }
            else if (CVisualization._direction == Directions.West)
            {
                DrawDownwards(CVisualization.WestCornerToRight, sectionData);
                CVisualization._direction = Directions.North;
            }
            else if (CVisualization._direction == Directions.North)
            {
                DrawUpwards(CVisualization.NorthCornerToRight, sectionData);
                CVisualization._direction = Directions.East;
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition += 1;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
                case Directions.North:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces + 1;
                    break;
                case Directions.South:
                    // do nothing
                    break;
            }
        }

        private static void DrawStraight(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StraightVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StraightHorizontal, sectionData);
        }

        private static void DrawStartGrid(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.StartGridVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.StartGridHorizontal, sectionData);
        }

        private static void DrawFinish(SectionData sectionData = null)
        {
            if (CVisualization.DirectionIsVertical())
            {
                CVisualization.Draw(CVisualization.FinishVertical, sectionData);
                return;
            }

            CVisualization.Draw(CVisualization.FinishHorizontal, sectionData);
        }

        private static void Draw(string[] symbols, SectionData sectionData = null)
        {
            if (CVisualization._direction is Directions.East or Directions.West or Directions.South)
            {
                DrawDownwards(symbols, sectionData);
            }
            else
            {
                DrawUpwards(symbols, sectionData);
            }

            switch (CVisualization._direction)
            {
                case Directions.East:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition += CVisualization.SymbolSpaces;
                    break;
                case Directions.West:
                    CVisualization._cursorNorthPosition -= CVisualization.SymbolSpaces;
                    CVisualization._cursorEastPosition -= CVisualization.SymbolSpaces;
                    break;
            }
        }

        private static void DrawDownwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorDownwards();
            }
        }

        private static void DrawUpwards(string[] symbols, SectionData sectionData = null)
        {
            string[] writeSymbols = CVisualization.SectionDataToSymbols(symbols, sectionData);

            foreach (string symbol in writeSymbols)
            {
                CVisualization.WriteLine(symbol);
                CVisualization.MoveCursorUpwards();
            }
        }

        private static string[] SectionDataToSymbols(string[] symbols, SectionData sectionData = null)
        {
            if (sectionData == null || (sectionData.Left == null &amp;&amp; sectionData.Right == null))
            {
                return symbols;
            }

            if (CVisualization.SectionIsCorner(sectionData.Section.SectionType))
            {
                return CVisualization.PlaceParticipantsOnCorner(symbols, sectionData);
            }
            
            if (sectionData.Left != null &amp;&amp; sectionData.Right != null)
            {
                return CVisualization.PlaceParticipantsOnSection(
                    symbols.ToArray(), 
                    sectionData.Left, sectionData.DistanceLeft, 
                    sectionData.Right, sectionData.DistanceRight
                );
            }

            return CVisualization.PlaceParticipantOnSection(
                symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight,
                sectionData.Left != null
            );
        }

        private static string[] PlaceParticipantsOnCorner(string[] symbols, SectionData sectionData)
        {
            if (sectionData.Left != null &amp;&amp; sectionData.Right != null)
            {
                if (sectionData.Section.SectionType == SectionTypes.RightCorner)
                {
                    return CVisualization.PlaceParticipantsOnRightCorner(
                        symbols.ToArray(), 
                        sectionData.Left, sectionData.DistanceLeft, 
                        sectionData.Right, sectionData.DistanceRight
                    );
                }
                
                return CVisualization.PlaceParticipantsOnLeftCorner(
                    symbols.ToArray(), 
                    sectionData.Left, sectionData.DistanceLeft, 
                    sectionData.Right, sectionData.DistanceRight
                );
            }

            if (sectionData.Section.SectionType == SectionTypes.RightCorner)
            {
                return CVisualization.PlaceParticipantOnRightCorner(
                    symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                    sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight
                );
            }
            
            return CVisualization.PlaceParticipantOnLeftCorner(
                symbols.ToArray(), sectionData.Left ?? sectionData.Right, 
                sectionData.Left != null ? sectionData.DistanceLeft : sectionData.DistanceRight
            );
        }

        private static string[] PlaceParticipantsOnLeftCorner(string[] symbols,IParticipant participantLeft, int distanceLeft, IParticipant participantRight, int distanceRight)
        {
            int
                indexOne = CVisualization.ConvertIndexForLeftCorner(distanceLeft, CVisualization._direction == Directions.East),
                indexTwo = CVisualization.ConvertIndexForLeftCorner(distanceRight, CVisualization._direction != Directions.East),
                distanceOne = CVisualization.ConvertDistanceForLeftCorner(distanceLeft, CVisualization._direction == Directions.East),
                distanceTwo = CVisualization.ConvertDistanceForLeftCorner(distanceRight, CVisualization._direction != Directions.East);

            string
                initialsOne = participantLeft.GetInitials(CVisualization.MaxInitialsLength),
                initialsTwo = participantRight.GetInitials(CVisualization.MaxInitialsLength);

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexTwo], initialsTwo, distanceTwo);
            
            return symbols;
        }

        private static string[] PlaceParticipantsOnRightCorner(string[] symbols,IParticipant participantLeft, int distanceLeft, IParticipant participantRight, int distanceRight)
        {
            int
                indexOne = CVisualization.ConvertIndexForRightCorner(distanceLeft, CVisualization._direction == Directions.West),
                indexTwo = CVisualization.ConvertIndexForRightCorner(distanceRight, CVisualization._direction != Directions.West),
                distanceOne = CVisualization.ConvertDistanceForRightCorner(distanceLeft, CVisualization._direction == Directions.West),
                distanceTwo = CVisualization.ConvertDistanceForRightCorner(distanceRight, CVisualization._direction != Directions.West);

            string
                initialsOne = participantLeft.GetInitials(CVisualization.MaxInitialsLength),
                initialsTwo = participantRight.GetInitials(CVisualization.MaxInitialsLength);

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexTwo], initialsTwo, distanceTwo);
            
            return symbols;
        }

        private static string[] PlaceParticipantOnLeftCorner(string[] symbols, IParticipant participant, int distance)
        {
            int index = CVisualization.ConvertIndexForLeftCorner(distance, CVisualization._direction == Directions.East),
                distanceOne = CVisualization.ConvertDistanceForLeftCorner(distance, CVisualization._direction == Directions.East);

            symbols[index] = CVisualization.MergeInitialsIntoSymbolByIndex(
                symbols[index], participant.GetInitials(CVisualization.MaxInitialsLength), distanceOne
            );

            return symbols;
        }

        private static string[] PlaceParticipantOnRightCorner(string[] symbols, IParticipant participant, int distance)
        {
            int index = CVisualization.ConvertIndexForRightCorner(distance, CVisualization._direction == Directions.West),
                distanceOne = CVisualization.ConvertDistanceForRightCorner(distance, CVisualization._direction == Directions.West);

            symbols[index] = CVisualization.MergeInitialsIntoSymbolByIndex(
                symbols[index], participant.GetInitials(CVisualization.MaxInitialsLength), distanceOne
            );

            return symbols;
        }
        
        private static string[] PlaceParticipantsOnSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            if (CVisualization.DirectionIsVertical())
            {
                return CVisualization.PlaceParticipantsOnVerticalSection(symbols, participantOne, distanceOne, participantTwo, distanceTwo);
            }
            
            return CVisualization.PlaceParticipantsOnHorizontalSection(symbols, participantOne, distanceOne, participantTwo, distanceTwo);
        }
        
        private static string[] PlaceParticipantOnSection(string[] symbols, IParticipant participant, int distance, bool left)
        {
            if (CVisualization.DirectionIsVertical())
            {
                return CVisualization.PlaceParticipantOnVerticalSection(symbols, participant, distance, left);
            }
            
            return CVisualization.PlaceParticipantOnHorizontalSection(symbols, participant, distance);
        }

        private static string[] PlaceParticipantsOnVerticalSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            int indexOne = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distanceOne);
            int indexTwo = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distanceTwo);
            if (indexOne &gt; 3)
            {
                indexOne = 3;
            }

            if (indexTwo &gt; 3)
            {
                indexTwo = 3;
            }
            
            string
                initialsStartOne = participantOne.GetInitials(CVisualization.MaxInitialsLength),
                initialsStartTwo = participantTwo.GetInitials(CVisualization.MaxInitialsLength),
                initialsOne = initialsStartOne,
                initialsTwo = initialsStartTwo;
            
            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexOne], initialsOne, 1);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[indexTwo], initialsTwo, 2);
            
            return symbols;
        }

        private static string[] PlaceParticipantsOnHorizontalSection(string[] symbols, IParticipant participantOne, int distanceOne, IParticipant participantTwo, int distanceTwo)
        {
            int indexOne = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex,
                indexTwo = CVisualization.InitialsOnPositionTwoInGraphicsSymbolsHorizontalIndex;
            string
                initialsStartOne = participantOne.GetInitials(CVisualization.MaxInitialsLength),
                initialsStartTwo = participantTwo.GetInitials(CVisualization.MaxInitialsLength),
                initialsOne = initialsStartOne,
                initialsTwo = initialsStartTwo;

            symbols[indexOne] = CVisualization.MergeInitialsIntoSymbol(symbols[indexOne], initialsOne, distanceOne);
            symbols[indexTwo] = CVisualization.MergeInitialsIntoSymbol(symbols[indexTwo], initialsTwo, distanceTwo);

            return symbols;
        }
        
        private static string[] PlaceParticipantOnVerticalSection(string[] symbols, IParticipant participant, int distance, bool left)
        {
            int index = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            if (index &gt; 3)
            {
                index = 3;
            }

            string initials = participant.GetInitials(CVisualization.MaxInitialsLength);
            
            symbols[index] = CVisualization.MergeInitialsIntoSymbolByIndex(symbols[index], initials, left ? 1 : 2);
            
            return symbols;
        }

        private static string[] PlaceParticipantOnHorizontalSection(string[] symbols, IParticipant participant, int distance)
        {
            int index = CVisualization.InitialsOnPositionOneInGraphicsSymbolsHorizontalIndex;

            symbols[index] = CVisualization.MergeInitialsIntoSymbol(
                symbols[index], participant.GetInitials(CVisualization.MaxInitialsLength), distance
            );

            return symbols;
        }

        private static void MoveCursorUpwards()
        {
            CVisualization._cursorNorthPosition--;
        }

        private static void MoveCursorDownwards()
        {
            CVisualization._cursorNorthPosition++;
        }

        private static void WriteLine(string symbol)
        {
            Console.SetCursorPosition(CVisualization._cursorEastPosition, CVisualization._cursorNorthPosition);
            Console.WriteLine(symbol);
        }

        private static string MergeInitialsIntoSymbol(string symbol, string initials, int distance)
        { 
            int initialsStartIndex = CVisualization.ConvertDistanceToSymbolIndex(distance);

            return CVisualization.MergeInitialsIntoSymbolByIndex(symbol, initials, initialsStartIndex);
        }

        private static string MergeInitialsIntoSymbolByIndex(string symbol, string initials, int index)
        {
            int maxInitialsLength = initials.Length &lt; CVisualization.MaxInitialsLength ? initials.Length : CVisualization.MaxInitialsLength;
            int startIndex = CVisualization.FlipSymbolIndexIfNecessary(index);

            string trimmedInitials = initials.ToString();
            if (initials.Length &gt; CVisualization.MaxInitialsLength)
            {
                trimmedInitials = trimmedInitials.Remove(CVisualization.MaxInitialsLength);
            }

            if ((trimmedInitials.Length + startIndex) &gt; symbol.Length)
            {
                return symbol;
            }

            return symbol.Remove(startIndex, maxInitialsLength).Insert(startIndex, trimmedInitials);
        }

        private static int ConvertDistanceToSymbolIndex(int distance)
        {
            return Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
        }

        private static int FlipSymbolIndexIfNecessary(int distance)
        {
            if (CVisualization._direction == Directions.West)
            {
                distance = Race.ConvertRange(0, CVisualization.SymbolSpaces, CVisualization.SymbolSpaces, 0, distance);
            }

            return distance;
        }
        
        private static int CenteredTextCursorStartPosition(string text)
        {
            return (Console.WindowWidth / 2) - (text.Length / 2);
        }

        private static bool SectionIsCorner(SectionTypes sectionType)
        {
            return sectionType == SectionTypes.LeftCorner || sectionType == SectionTypes.RightCorner;
        }
        
        private static int ConvertIndexForRightCorner(int distance, bool right)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            switch (newDistance)
            {
                case 0:
                    if (CVisualization._direction == Directions.East)
                    {
                        return right ? 2 : 1;
                    }

                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return 0;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return right ? 1 : 2;
                    }

                    return 2;
                case 1:
                    if (CVisualization._direction == Directions.East)
                    {
                        return right ? 2 : 1;
                    }

                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return 1;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return right ? 1 : 2;
                    }
                    
                    return 2;
                case 2:
                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return right ? 1 : 2;
                    }
                    
                    if (CVisualization._direction == Directions.West)
                    {
                        return 1;
                    }
                    
                    return 2;
                default:
                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return right ? 1 : 2;
                    }
                    
                    if (CVisualization._direction == Directions.West)
                    {
                        return 0;
                    }

                    return 3;
            }
        }
        
        private static int ConvertDistanceForRightCorner(int distance, bool right)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            switch (newDistance)
            {
                case 0:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 0;
                    }

                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return right ? 2 : 1;
                    }

                    return 1;
                case 1:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 1;
                    }
                    
                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return right ? 2 : 1;
                    }

                    return 2;
                case 2:
                    if (CVisualization._direction == Directions.East)
                    {
                        return right ? 1 : 2;
                    }
                    
                    if (CVisualization._direction == Directions.South)
                    {
                        return 1;
                    }
                    
                    if (CVisualization._direction == Directions.West)
                    {
                        return right ? 2 : 3;
                    }

                    return 2;
                default:
                    if (CVisualization._direction == Directions.East)
                    {
                        return right ? 1 : 2;
                    }
                    
                    if (CVisualization._direction == Directions.South)
                    {
                        return 0;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return right ? 2 : 3;
                    }

                    return 3;
            }
        }

        private static int ConvertIndexForLeftCorner(int distance, bool left)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            switch (newDistance)
            {
                case 0:
                    if (CVisualization._direction == Directions.East)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return left ? 2 : 1;
                    }

                    return 0;
                case 1:
                    if (CVisualization._direction == Directions.East)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return left ? 2 : 1;
                    }
                    
                    return 1;
                case 2:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 1;
                    }

                    if (CVisualization._direction == Directions.South)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.North)
                    {
                        return left ? 2 : 1;
                    }
                    
                    return 2;
                default:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 0;
                    }
                    
                    if (CVisualization._direction == Directions.South)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.North)
                    {
                        return left ? 2 : 1;
                    }

                    return 3;
            }
        }
        
        private static int ConvertDistanceForLeftCorner(int distance, bool left)
        {
            int newDistance = Race.ConvertRange(0, Race.SectionLength, 0, CVisualization.SymbolSpaces, distance);
            switch (newDistance)
            {
                case 0:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 0;
                    }

                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return left ? 2 : 1;
                    }

                    return 1;
                case 1:
                    if (CVisualization._direction == Directions.East)
                    {
                        return 1;
                    }
                    
                    if (CVisualization._direction == Directions.South || CVisualization._direction == Directions.North)
                    {
                        return left ? 2 : 1;
                    }

                    return 2;
                case 2:
                    if (CVisualization._direction == Directions.East)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return left ? 2 : 3;
                    }

                    if (CVisualization._direction == Directions.North)
                    {
                        return 1;
                    }
                    
                    return 2;
                default:
                    if (CVisualization._direction == Directions.East)
                    {
                        return left ? 1 : 2;
                    }

                    if (CVisualization._direction == Directions.West)
                    {
                        return left ? 2 : 3;
                    }

                    if (CVisualization._direction == Directions.North)
                    {
                        return 0;
                    }
                    
                    return 3;
            }
        }
        
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,78,0],[25,9,25,79,0],[47,9,48,62,0],[49,13,49,64,0],[51,9,52,58,0],[53,13,53,60,0],[57,9,58,64,0],[59,13,59,62,0],[61,13,61,67,0],[62,13,62,65,0],[64,13,64,66,0],[65,13,65,64,0],[67,13,67,66,0],[68,13,68,68,0],[70,13,70,68,0],[71,13,71,64,0],[73,13,73,65,0],[74,13,74,68,0],[76,13,76,65,0],[77,13,77,64,0],[81,9,81,10,0],[82,13,82,68,0],[83,9,83,10,0],[86,9,86,10,0],[87,13,87,54,0],[88,9,88,10,0],[91,9,91,10,0],[92,13,92,38,0],[94,13,94,57,0],[95,13,95,58,0],[96,13,96,29,0],[98,13,98,87,0],[99,13,99,43,0],[101,13,101,72,0],[102,13,102,89,0],[103,13,103,73,0],[104,13,104,14,0],[105,17,105,78,0],[106,13,106,14,0],[108,13,108,91,0],[109,13,109,74,0],[110,13,110,14,0],[111,17,111,80,0],[112,13,112,14,0],[114,13,114,20,0],[114,22,114,42,0],[114,43,114,45,0],[114,46,114,60,0],[115,13,115,14,0],[116,17,116,98,0],[117,13,117,14,0],[118,9,118,10,0],[121,9,121,10,0],[122,13,122,41,0],[125,21,125,48,0],[126,21,126,27,0],[128,21,128,47,0],[129,21,129,27,0],[131,21,131,49,0],[132,21,132,27,0],[134,21,134,50,0],[135,21,135,27,0],[137,21,137,45,0],[138,21,138,27,0],[140,21,140,90,0],[142,9,142,10,0],[145,9,145,10,0],[146,13,146,86,0],[147,9,147,10,0],[150,9,150,10,0],[151,13,151,62,0],[152,13,152,14,0],[153,17,153,77,0],[154,17,154,62,0],[155,13,155,14,0],[156,18,156,68,0],[157,13,157,14,0],[158,17,158,78,0],[159,17,159,61,0],[160,13,160,14,0],[161,18,161,67,0],[162,13,162,14,0],[163,17,163,77,0],[164,17,164,62,0],[165,13,165,14,0],[166,18,166,68,0],[167,13,167,14,0],[168,17,168,76,0],[169,17,169,61,0],[170,13,170,14,0],[172,13,172,47,0],[175,21,175,88,0],[176,21,176,87,0],[177,21,177,27,0],[179,21,179,62,0],[180,21,180,87,0],[181,21,181,27,0],[183,21,183,92,0],[184,21,184,27,0],[187,21,187,27,0],[189,9,189,10,0],[192,9,192,10,0],[193,13,193,62,0],[194,13,194,14,0],[195,17,195,78,0],[196,17,196,62,0],[197,13,197,14,0],[198,18,198,68,0],[199,13,199,14,0],[200,17,200,79,0],[201,17,201,61,0],[202,13,202,14,0],[203,18,203,67,0],[204,13,204,14,0],[205,17,205,78,0],[206,17,206,62,0],[207,13,207,14,0],[208,18,208,68,0],[209,13,209,14,0],[210,17,210,77,0],[211,17,211,61,0],[212,13,212,14,0],[214,13,214,47,0],[217,21,217,62,0],[218,21,218,87,0],[219,21,219,27,0],[221,21,221,88,0],[222,21,222,87,0],[223,21,223,27,0],[225,21,225,92,0],[226,21,226,27,0],[229,21,229,27,0],[231,9,231,10,0],[234,9,234,10,0],[235,13,235,54,0],[236,13,236,14,0],[237,17,237,83,0],[238,17,238,24,0],[241,13,241,81,0],[242,9,242,10,0],[245,9,245,10,0],[246,13,246,54,0],[247,13,247,14,0],[248,17,248,84,0],[249,17,249,24,0],[252,13,252,82,0],[253,9,253,10,0],[256,9,256,10,0],[257,13,257,54,0],[258,13,258,14,0],[259,17,259,81,0],[260,17,260,24,0],[263,13,263,79,0],[264,9,264,10,0],[267,9,267,10,0],[268,13,268,101,0],[269,13,269,14,0],[270,17,270,53,0],[271,13,271,14,0],[273,13,273,14,0],[274,17,274,51,0],[275,13,275,14,0],[277,13,277,47,0],[280,21,280,88,0],[281,21,281,87,0],[282,21,282,27,0],[284,21,284,88,0],[285,21,285,87,0],[286,21,286,27,0],[288,9,288,10,0],[291,9,291,10,0],[292,13,292,95,0],[294,13,294,20,0],[294,22,294,35,0],[294,36,294,38,0],[294,39,294,51,0],[295,13,295,14,0],[296,17,296,50,0],[297,17,297,54,0],[298,13,298,14,0],[299,9,299,10,0],[302,9,302,10,0],[303,13,303,95,0],[305,13,305,20,0],[305,22,305,35,0],[305,36,305,38,0],[305,39,305,51,0],[306,13,306,14,0],[307,17,307,50,0],[308,17,308,52,0],[309,13,309,14,0],[310,9,310,10,0],[313,9,313,10,0],[314,13,314,96,0],[315,13,315,14,0],[316,17,316,32,0],[319,13,319,81,0],[320,13,320,14,0],[321,17,321,87,0],[324,13,324,71,0],[325,13,325,14,0],[326,17,330,19,0],[333,13,337,15,0],[338,9,338,10,0],[341,9,341,10,0],[342,13,342,71,0],[343,13,343,14,0],[344,17,344,81,0],[345,17,345,18,0],[346,21,350,23,0],[353,17,357,19,0],[360,13,360,77,0],[361,13,361,14,0],[362,17,365,19,0],[368,13,371,15,0],[372,9,372,10,0],[375,9,375,10,0],[376,13,377,128,0],[378,17,378,129,0],[379,17,379,134,0],[380,17,380,135,0],[382,13,383,92,0],[384,17,384,93,0],[386,13,386,124,0],[387,13,387,124,0],[389,13,389,28,0],[390,9,390,10,0],[393,9,393,10,0],[394,13,395,129,0],[396,17,396,130,0],[397,17,397,135,0],[398,17,398,136,0],[400,13,401,92,0],[402,17,402,93,0],[404,13,404,124,0],[405,13,405,124,0],[407,13,407,28,0],[408,9,408,10,0],[411,9,411,10,0],[412,13,412,121,0],[413,17,413,130,0],[415,13,417,15,0],[419,13,419,28,0],[420,9,420,10,0],[423,9,423,10,0],[424,13,424,122,0],[425,17,425,131,0],[427,13,429,15,0],[431,13,431,28,0],[432,9,432,10,0],[435,9,435,10,0],[436,13,436,54,0],[437,13,437,14,0],[438,17,438,141,0],[441,13,441,139,0],[442,9,442,10,0],[445,9,445,10,0],[446,13,446,54,0],[447,13,447,14,0],[448,17,448,111,0],[451,13,451,103,0],[452,9,452,10,0],[455,9,455,10,0],[456,13,456,114,0],[457,13,457,114,0],[458,13,458,30,0],[459,13,459,14,0],[460,17,460,30,0],[461,13,461,14,0],[463,13,463,30,0],[464,13,464,14,0],[465,17,465,30,0],[466,13,466,14,0],[468,13,469,96,0],[470,17,470,96,0],[471,17,471,47,0],[472,17,472,47,0],[474,13,474,114,0],[475,13,475,114,0],[477,13,477,28,0],[478,9,478,10,0],[481,9,481,10,0],[482,13,482,96,0],[483,17,483,96,0],[484,13,485,96,0],[486,17,486,96,0],[487,17,487,47,0],[488,17,488,47,0],[490,13,490,117,0],[491,13,491,117,0],[493,13,493,28,0],[494,9,494,10,0],[497,9,497,10,0],[498,13,498,108,0],[499,13,499,27,0],[500,13,500,14,0],[501,17,501,27,0],[502,13,502,14,0],[504,13,504,89,0],[506,13,506,116,0],[508,13,508,28,0],[509,9,509,10,0],[512,9,512,10,0],[513,13,513,94,0],[515,13,517,15,0],[519,13,519,28,0],[520,9,520,10,0],[523,9,523,10,0],[524,13,524,51,0],[525,9,525,10,0],[528,9,528,10,0],[529,13,529,51,0],[530,9,530,10,0],[533,9,533,10,0],[534,13,534,112,0],[535,13,535,39,0],[536,9,536,10,0],[539,9,539,10,0],[540,13,540,92,0],[542,13,542,104,0],[543,9,543,10,0],[546,9,546,10,0],[547,13,547,141,0],[548,13,548,79,0],[550,13,550,58,0],[551,13,551,68,0],[552,13,552,14,0],[553,17,553,92,0],[554,13,554,14,0],[556,13,556,71,0],[557,13,557,14,0],[558,17,558,31,0],[561,13,561,101,0],[562,9,562,10,0],[565,9,565,10,0],[566,13,566,103,0],[567,9,567,10,0],[570,9,570,10,0],[571,13,571,62,0],[572,13,572,14,0],[573,17,573,120,0],[574,13,574,14,0],[576,13,576,29,0],[577,9,577,10,0],[580,9,580,10,0],[581,13,581,66,0],[582,9,582,10,0],[585,9,585,10,0],[586,13,586,102,0],[587,9,587,10,0],[590,9,590,10,0],[591,13,591,114,0],[592,13,592,33,0],[595,21,595,70,0],[596,21,596,22,0],[597,25,597,46,0],[600,21,600,120,0],[601,21,601,22,0],[602,25,602,34,0],[605,21,605,70,0],[606,21,606,22,0],[607,25,607,46,0],[610,21,610,30,0],[612,21,612,70,0],[613,21,613,22,0],[614,25,614,46,0],[617,21,617,120,0],[618,21,618,22,0],[619,25,619,34,0],[622,21,622,70,0],[623,21,623,22,0],[624,25,624,46,0],[627,21,627,30,0],[629,21,629,120,0],[630,21,630,22,0],[631,25,631,46,0],[634,21,634,70,0],[635,21,635,22,0],[636,25,636,34,0],[639,21,639,30,0],[641,21,641,120,0],[642,21,642,22,0],[643,25,643,46,0],[646,21,646,70,0],[647,21,647,22,0],[648,25,648,34,0],[651,21,651,30,0],[653,9,653,10,0],[656,9,656,10,0],[657,13,657,114,0],[658,13,658,33,0],[661,21,661,70,0],[662,21,662,22,0],[663,25,663,34,0],[666,21,666,120,0],[667,21,667,22,0],[668,25,668,46,0],[671,21,671,30,0],[673,21,673,70,0],[674,21,674,22,0],[675,25,675,34,0],[678,21,678,120,0],[679,21,679,22,0],[680,25,680,46,0],[683,21,683,30,0],[685,21,685,70,0],[686,21,686,22,0],[687,25,687,46,0],[690,21,690,71,0],[691,21,691,22,0],[692,25,692,34,0],[695,21,695,70,0],[696,21,696,22,0],[697,25,697,46,0],[700,21,700,30,0],[702,21,702,70,0],[703,21,703,22,0],[704,25,704,46,0],[707,21,707,71,0],[708,21,708,22,0],[709,25,709,34,0],[712,21,712,70,0],[713,21,713,22,0],[714,25,714,46,0],[717,21,717,30,0],[719,9,719,10,0],[722,9,722,10,0],[723,13,723,114,0],[724,13,724,33,0],[727,21,727,70,0],[728,21,728,22,0],[729,25,729,45,0],[732,21,732,70,0],[733,21,733,22,0],[734,25,734,45,0],[737,21,737,30,0],[739,21,739,70,0],[740,21,740,22,0],[741,25,741,45,0],[744,21,744,70,0],[745,21,745,22,0],[746,25,746,45,0],[749,21,749,30,0],[751,21,751,70,0],[752,21,752,22,0],[753,25,753,34,0],[756,21,756,71,0],[757,21,757,22,0],[758,25,758,45,0],[761,21,761,71,0],[762,21,762,22,0],[763,25,763,45,0],[766,21,766,30,0],[768,21,768,70,0],[769,21,769,22,0],[770,25,770,34,0],[773,21,773,71,0],[774,21,774,22,0],[775,25,775,45,0],[778,21,778,71,0],[779,21,779,22,0],[780,25,780,45,0],[783,21,783,30,0],[785,9,785,10,0],[788,9,788,10,0],[789,13,789,114,0],[790,13,790,33,0],[793,21,793,70,0],[794,21,794,22,0],[795,25,795,34,0],[798,21,798,120,0],[799,21,799,22,0],[800,25,800,45,0],[803,21,803,30,0],[805,21,805,70,0],[806,21,806,22,0],[807,25,807,34,0],[810,21,810,120,0],[811,21,811,22,0],[812,25,812,45,0],[815,21,815,30,0],[817,21,817,70,0],[818,21,818,22,0],[819,25,819,45,0],[822,21,822,70,0],[823,21,823,22,0],[824,25,824,45,0],[827,21,827,71,0],[828,21,828,22,0],[829,25,829,34,0],[832,21,832,30,0],[834,21,834,70,0],[835,21,835,22,0],[836,25,836,45,0],[839,21,839,70,0],[840,21,840,22,0],[841,25,841,45,0],[844,21,844,71,0],[845,21,845,22,0],[846,25,846,34,0],[849,21,849,30,0],[851,9,851,10,0]]);
    </script>
  </body>
</html>